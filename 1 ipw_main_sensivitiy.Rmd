---
title: "DIPRES: outcomes substance use and mental health"
author: "Ignacio Borquez Infante"
date: "2023-04-27"
output: html_document
---

# Directory
```{r}
setwd("")
options(max.print=10000)
```

# Packages
```{r}
# Remove all objects from the environment
rm(list = ls())

# Perform garbage collection to free up memory
gc()

library(haven)
library(gmodels)
library(dplyr)
library(arsenal)
library(ipw)
library(mice)
library(miceadds)
library(gtsummary)
library(nnet)
library(geepack)
library(ltm)
library(tidysmd)
library(tableone)
library(survey)
library(writexl)
library(ggplot2)
library(marginaleffects)
#library(interactions)
```

# Analysis
## Filter sensitivity analysis 1
```{r eval=FALSE}
df_outcome <- subset(df_outcome, tto_30dias_t0 == "Yes")
df_outcome <- subset(df_outcome, prev_tto != "4 or more months")
df_outcome$prev_tto <- droplevels(df_outcome$prev_tto)
table(df_outcome$tto_30dias_t0)
table(df_outcome$prev_tto)
```



## T-test change over time in the outcomes - paired ttest
```{r eval=FALSE}
df_ttest <- df_outcome[df_outcome$t2==1,]

# Primary substance prevalence
before <- as.numeric(df_ttest$sp_mprev_t0)
after <- as.numeric(df_ttest$sp_mprev_t2)
t.test(before, after, paired = TRUE)

# Alcohol
before <- as.numeric(df_ttest$alco_mprev_t0)
after <- as.numeric(df_ttest$alco_mprev_t2)
t.test(before, after, paired = TRUE)

# Cannabis
before <- as.numeric(df_ttest$mar_mprev_t0)
after <- as.numeric(df_ttest$mar_mprev_t2)
t.test(before, after, paired = TRUE)

# Cocaine powder
before <- as.numeric(df_ttest$coc_mprev_t0)
after <- as.numeric(df_ttest$coc_mprev_t2)
t.test(before, after, paired = TRUE)

# Cocaine paste
before <- as.numeric(df_ttest$pb_mprev_t0)
after <- as.numeric(df_ttest$pb_mprev_t2)
t.test(before, after, paired = TRUE)

# Psychiatric comorbidity
before <- as.numeric(df_ttest$psyc_comor_t0)
after <- as.numeric(df_ttest$psyc_comor_t2)
t.test(before, after, paired = TRUE)

# MDE
before <- as.numeric(df_ttest$sld_mini_depact_t0)
after <- as.numeric(df_ttest$sld_mini_depact_t2)
t.test(before, after, paired = TRUE)

# Panic
before <- as.numeric(df_ttest$sld_mini_angusactual_t0)
after <- as.numeric(df_ttest$sld_mini_angusactual_t2)
t.test(before, after, paired = TRUE)

# Anxiety
before <- as.numeric(df_ttest$sld_mini_tans_t0)
after <- as.numeric(df_ttest$sld_mini_tans_t2)
t.test(before, after, paired = TRUE)

# PTSD
before <- as.numeric(df_ttest$sld_mini_eept_t0)
after <- as.numeric(df_ttest$sld_mini_eept_t2)
t.test(before, after, paired = TRUE)
```

# IPCW - Censoring at wave 2
## Table
```{r eval=FALSE}
cen_02 <- tableby(t2 ~ alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + pb_mprev_t0 + 
                       tranq_mprev_t0 + drgs_sp_t0 + drgs_ini + drgs_polimes_t0 + # Outcomes + SU
                       tto_30dias_t0 + programa_t0 + ssm + ratio + p42 + # Center covariates
                       sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                       readi + # Motivation to change
                       prev_tto + tto_primertrata_t0 + # Prior treatment
                       partner_t0 + redes_vivedrogas_t0 + net_index_t0 + # Family and cohabitation
                       peers_sud_t0 + friends_t0 +  prtcp_9_t0 + # Peers and Self-support groups
                       phy_comor + psyc_comor_t0 + sld_mini_antisoc_t0 + # Comorbidities
                       dis_event_t0 + fp_crime_t0,  # Disruptive events and For-profit crimes                       
                  data = df_tables, numeric.stats=c("mean", "sd", "Nmiss", "N"),
                  digits=1, digits.p=3, digits.pct=1)

summary(cen_02, labelTranslations = mylabels, text=TRUE)
```

## IPCW
```{r eval=FALSE}
df_outcome <- df_tables

# MICE
df_model <- df_outcome[c("folio", "t2", 
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family quality index and cohabitation with SUD
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0")] # Disruptive events and For-profit crimes     

# % misssing
p_missing <- unlist(lapply(df_model, function(x) sum(is.na(x))))/nrow(df_model)
round(sort(p_missing[p_missing > 0], decreasing = TRUE)*100,2)

# Run the mice code with 0 iterations 
imp <- mice(df_model, maxit=0)

# Extract predictorMatrix and methods of imputation 
predM <- imp$predictorMatrix
meth <- imp$method

# Setting values of variables I'd like to leave out to 0 in the predictor matrix
predM[, c("folio")] <- 0

# Specify a separate imputation model for variables of interest 

# Numerical variables
num <- c("readi", "ratio", "net_index_t0")

# Dichotomous variable
log <- c("p42", "tranq_mprev_t0", 
         "pb_mprev_t0", "tto_30dias_t0", "tbjo_t0", "redes_vivedrogas_t0",  
         "drgs_ini", "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0",  
         "tto_primertrata_t0", "prtcp_9_t0", "sld_mini_antisoc_t0")

# Ordered categorical variables 
poly <- c("educ_nivel2_t0")

# Unordered categorical variable 
poly2 <- c("prev_tto")

# Turn their methods matrix into the specified imputation models
meth[num] <- "norm.boot"
meth[log] <- "logreg.boot"
meth[poly] <- "polyreg"
meth[poly2] <- "polyreg"

# MICE
set.seed(12345)
imp_c <- mice(df_model, 
             m = 30,
             maxit = 10, 
             predictorMatrix = predM, 
             method = meth,
             print = FALSE)

# Initialize a list to store the ipcwpoint results for each imputed dataset
ipcws_list <- list()

# Loop over each imputed dataset
for (i in 1:30) {
  # Extract the imputed dataset for the current iteration
  imp_data <- complete(imp_c, action = i)
  
  # Perform ipwpoint on the current imputed dataset
  ipw_result <- ipwpoint(
    exposure = t2,  
    family = "binomial",
    link = "logit",
    numerator = ~ 1 , 
    denominator = ~ tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + pb_mprev_t0 + # Substance use
                    tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini + drgs_sp_t0 + # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 +  # Family and cohabitation
                    peers_sud_t0 +  prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor + psyc_comor_t0 + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0, # Disruptive events and For-profit crimes  
    data = imp_data
  )
  
  # Store in list
  ipcws_list[[i]] <- ipw_result
}

# Create a matrix to store IPCW results for each imputed dataset
ipcws_matrix <- matrix(NA, nrow = nrow(df_model), ncol = 30)

# Extract the IPCW results each imputed dataset
for (i in 1:30) {
  ipcws_matrix[, i] <- ipcws_list[[i]]$ipw.weights
}

# Calculate the mean IPCW across imputed datasets for each observation
df_model$ipcw_t2 <- rowMeans(ipcws_matrix, na.rm = TRUE)

# Predicted probabilities
# Combine imputed datasets into a single dataset
complete_data <- mice::complete(imp_c, action = "long", include = TRUE)

# Perform logistic regression on the complete dataset
complete_model <- glm(t2 ~ tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + pb_mprev_t0 + drgs_sp_t0 + # Substance use
                    tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini + # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 +  # Family and cohabitation
                    peers_sud_t0 +  prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor + psyc_comor_t0 + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0, # Disruptive events and For-profit crimes    
                       data = complete_data, family = binomial)

# Predict probabilities
predicted_probs <- predict(complete_model, newdata = complete_data, type = "response")

# Combine predicted probabilities with the original dataset
complete_data_with_probs <- cbind(complete_data, Predicted_Prob = predicted_probs)

# Average predicted probabilities by folio
average_probs_by_folio <- aggregate(Predicted_Prob ~ folio, data = complete_data_with_probs, FUN = mean)

# Probability to df_model
df_model$pr_notcen_t2 <- average_probs_by_folio$Predicted_Prob

# Propensity model results table
m_t2 <- with(imp_c,
            glm(t2 ~ tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + pb_mprev_t0 + drgs_sp_t0 + # Substance use
                    tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini + # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 +  # Family and cohabitation
                    peers_sud_t0 +  prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor + psyc_comor_t0 + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0, # Disruptive events and For-profit crimes    
                 data = imp_data, family = binomial)) %>%
              tbl_regression(exponentiate = TRUE, label = mylabels)
m_t2

#save(imp_c, file = "imp_c_v2.Rda")
```

### Plot
```{r eval=FALSE}
# Look at the weights
summary(df_model$ipcw_t2)
hist(df_model$ipcw_t2, main = "IPCW Density", xlab = "IPCW", breaks = 300)
density_plot <- density(df_model$ipcw_t2)
plot(density_plot, main = "IPCW T2 Density", xlab = "IPCW", col = "blue")

# Inverse probability weight
# Check density across censored and uncensored T2
density_plot_t2_1 <- density(df_model$ipcw_t2[df_model$t2 == 1], na.rm = TRUE)
density_plot_t2_0 <- density(df_model$ipcw_t2[df_model$t2 == 0], na.rm = TRUE)

# Plot 
plot(density_plot_t2_1, main = "IPCW T2 Density by censored", xlab = "IPCW", col = "blue", xlim = c(0, max(df_model$ipcw_t2)))
lines(density_plot_t2_0, col = "red")
legend("topright", legend = c("Not Censored", "Censored"), col = c("blue", "red"), lty = 1)

# Probability
summary(df_model$pr_notcen_t2)

density_plot <- density(df_model$pr_notcen_t2)
plot(density_plot, main = "Prob Not Censored T2 Density", xlab = "Probability not censored", col = "blue", xlim = c(0, 1))

# Check density across censored and uncensored T2
density_plot_t2_1 <- density(df_model$pr_notcen_t2[df_model$t2 == 1], na.rm = TRUE, bw = 0.02)
density_plot_t2_0 <- density(df_model$pr_notcen_t2[df_model$t2 == 0], na.rm = TRUE, bw = 0.02)

# Plot 
plot(density_plot_t2_1, main = "Prob Not Censored T2 Density by censored", xlab = "Probability not censored", col = "blue", xlim = c(0,  1), ylim = c(0,3))
lines(density_plot_t2_0, col = "red")
legend("topleft", legend = c("Not Censored", "Censored"), col = c("blue", "red"), lty = 1)

percentiles <- quantile(df_model$ipcw_t2, c(0, 0.02, 0.05, 0.1, 0.35, 0.5, 0.75, 0.9, 0.95, 0.98, 1), na.rm = T)
percentiles
```

## Extract ipcw for outcome regression
```{r eval=FALSE}
df_ipcw_t2 <- df_model[,c("folio","ipcw_t2","pr_notcen_t2")]
save(df_ipcw_t2, file = "df_ipcw_t2_v2.Rdata")
```

## Standardized mean differences
```{r eval=FALSE}
load(file = "df_ipcw_t2_v2.Rdata")

## Create a variable list
vars <- c("t2", #  Group
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0")

# IPCW
df_outcome <- df_tables
df_outcome <- merge(df_outcome,df_ipcw_t2,by="folio", all = T) 

df_outcome <- df_outcome[!is.na(df_outcome$ipcw_t2), ]

tabNot <- CreateTableOne(vars = vars, strata = c("t2"), smd = T, data = df_outcome)

# Create weighted data
df_outcome_Svy <- svydesign(ids = ~ 1, data = df_outcome, weights = ~ ipcw_t2)

## Create Table 1 stratified by trt
tabWeighted <- svyCreateTableOne(vars = vars, strata = c("t2"), data = df_outcome_Svy, test = FALSE)

## Just typing the object name will invoke the print.TableOne method
print(tabNot, smd = TRUE, labels = mylabels)
print(tabWeighted, smd = TRUE, labels = mylabels)
```


# IPTW - Time in treatment
## Table
```{r eval=FALSE}
df_outcome <- df_tables
df_m <- df_outcome[df_outcome$t2==1,]

treat_1 <- tableby(treat_time_t1_v1 ~ 
                     sp_mprev_t0 + sp_mprev_t2 +
                     alco_mprev_t0 + alco_mprev_t2 +
                     mar_mprev_t0 + mar_mprev_t2 +
                     coc_mprev_t0 + coc_mprev_t2 +
                     pb_mprev_t0 + pb_mprev_t2 + 
                       psyc_comor_t0 + sld_mini_depact_t0 + sld_mini_angusactual_t0 + sld_mini_tans_t0 + sld_mini_eept_t0 +
                       psyc_comor_t2 + sld_mini_depact_t2 + sld_mini_angusactual_t2 + sld_mini_tans_t2 + sld_mini_eept_t2 +
                       tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                       sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                       drgs_sp_t0 + drgs_polimes_t0 + tranq_mprev_t0 + drgs_ini + drgs_sp_t0 + # Substance use
                       readi + # Motivation to change
                       prev_tto + tto_primertrata_t0 + # Prior treatment
                       redes_vivedrogas_t0 + net_index_t0 + # Family and cohabitation
                       peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                       phy_comor +  + sld_mini_antisoc_t0 + # Comorbidities
                       dis_event_t0 + fp_crime_t0 + aces + victnna_num,  # Disruptive events and For-profit crimes                       
                  data = df_m, numeric.stats=c("mean", "sd", "Nmiss", "N"),
                  digits=1, digits.p=3, digits.pct=1)

summary(treat_1, labelTranslations = mylabels, text=TRUE)
```

## Weights
```{r eval=FALSE}
df_outcome <- df_tables
# MICE
df_model <- df_outcome[c("folio", "t2", 
                   "treat_time_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")] # Disruptive events, For-profit crimes and ACEs   

df_model <- df_model[df_model$t2==1,]
df_model <- df_model[complete.cases(df_model$treat_time_t1_v1), ]

p_missing <- unlist(lapply(df_model, function(x) sum(is.na(x))))/nrow(df_model)
round(sort(p_missing[p_missing > 0], decreasing = TRUE)*100,2)

df_model$treat <- as.numeric(df_model$treat_time_t1_v1)

# Run the mice code with 0 iterations 
imp <- mice(df_model, maxit=0)

# Extract predictorMatrix and methods of imputation 
predM <- imp$predictorMatrix
meth <- imp$method

# Setting values of variables I'd like to leave out to 0 in the predictor matrix
predM[, c("folio")] <- 0

# Specify a separate imputation model for variables of interest 

# Numerical variables
num <- c("readi", "ratio", "net_index_t0", "victnna_num")

# Dichotomous variable
log <- c("p42","tranq_mprev_t0", "tbjo_t0", "pb_mprev_t0",
          "tto_30dias_t0", "drgs_ini", "redes_vivedrogas_t0",  "mar_mprev_t0", 
         "coc_mprev_t0", "tto_primertrata_t0", "sld_mini_antisoc_t0")

# Ordered categorical variables 
poly <- c("educ_nivel2_t0")

# Unordered categorical variable 
poly2 <- c("prev_tto")

# Turn their methods matrix into the specified imputation models
meth[num] <- "norm.boot"
meth[log] <- "logreg.boot"
meth[poly] <- "polyreg"
meth[poly2] <- "polyreg"

# MICE
set.seed(12345)
imp_t <- mice(df_model, 
             m = 30,
             maxit = 10, 
             predictorMatrix = predM, 
             method = meth,
             print = FALSE)

# Initialize list ipwpoint results
iptws_list <- list()

# Loop 
for (i in 1:30) {
  # Imputed dataset for the current iteration
  imp_data <- complete(imp_t, action = i)
  
  # Perform ipwpoint
  ipw_result <- ipwpoint(
    exposure = treat_time_t1_v1,  
    family = "multinomial",
    numerator = ~ 1,
    denominator = ~ tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + 
                    pb_mprev_t0 + tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini + drgs_sp_t0 + # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 + # Family and cohabitation
                    peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor + psyc_comor_t0 + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0 + victnna_num,
    data = imp_data
  )
    
  # Store the ipcwpoint
  iptws_list[[i]] <- ipw_result
}

# Initialize a matrix to store IPCW results for each imputed dataset
iptws_matrix <- matrix(NA, nrow = nrow(df_model), ncol = 30)

# Loop over each imputed dataset
for (i in 1:30) {
  iptws_matrix[, i] <- iptws_list[[i]]$ipw.weights
}

# Calculate the mean IPCW 
df_model$iptw_tt_t1 <- rowMeans(iptws_matrix, na.rm = TRUE)

# Predicted probabilities
# Combine imputed datasets
complete_data <- mice::complete(imp_t, action = "long", include = TRUE)

# Perform logistic regression on the complete dataset
complete_model <- multinom(treat_time_t1_v1 ~ 
                           tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                           sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                           alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + 
                           pb_mprev_t0 + tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini +  drgs_sp_t0 + # Substance use
                           readi + # Motivation to change
                           prev_tto + tto_primertrata_t0 + # Prior treatment
                           net_index_t0 + redes_vivedrogas_t0 + # Family and cohabitation
                           peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                           phy_comor + psyc_comor_t0 + sld_mini_antisoc_t0 + # Comorbidities
                           dis_event_t0 + fp_crime_t0 + victnna_num,  
                           data = complete_data)

# Predict probabilities for each observation in the combined dataset
predicted_probs <- fitted(complete_model, type = "response")

# Add folio variable to predicted_probs == 1
predicted_probs_with_folio <- cbind(complete_data$folio, Predicted_Prob = predicted_probs[,1])

average_probs_by_folio <- aggregate(Predicted_Prob ~ V1, data = predicted_probs_with_folio, FUN = mean)

# Rename
average_probs_by_folio <- average_probs_by_folio %>%
  rename(folio = V1)

# Extract predicted prob
df_model$pr_tt1_t1 <- average_probs_by_folio$Predicted_Prob

# Add folio variable to predicted_probs == 2
predicted_probs_with_folio <- cbind(complete_data$folio, Predicted_Prob = predicted_probs[,2])

average_probs_by_folio <- aggregate(Predicted_Prob ~ V1, data = predicted_probs_with_folio, FUN = mean)

average_probs_by_folio <- average_probs_by_folio %>%
  rename(folio = V1)

df_model$pr_tt2_t1 <- average_probs_by_folio$Predicted_Prob

# Add folio variable to predicted_probs == 3
predicted_probs_with_folio <- cbind(complete_data$folio, Predicted_Prob = predicted_probs[,3])

average_probs_by_folio <- aggregate(Predicted_Prob ~ V1, data = predicted_probs_with_folio, FUN = mean)

average_probs_by_folio <- average_probs_by_folio %>%
  rename(folio = V1)

df_model$pr_tt3_t1 <- average_probs_by_folio$Predicted_Prob

# Add folio variable to predicted_probs == 4
predicted_probs_with_folio <- cbind(complete_data$folio, Predicted_Prob = predicted_probs[,4])

average_probs_by_folio <- aggregate(Predicted_Prob ~ V1, data = predicted_probs_with_folio, FUN = mean)

average_probs_by_folio <- average_probs_by_folio %>%
  rename(folio = V1)

df_model$pr_tt4_t1 <- average_probs_by_folio$Predicted_Prob

# Probability actual treatment
df_model$pr_tt_t1 <- NA
df_model$pr_tt_t1[df_model$treat_time_t1_v1 == "3 or less months"] <- df_model$pr_tt1_t1
df_model$pr_tt_t1[df_model$treat_time_t1_v1 == "4 to 7 months" & is.na(df_model$pr_tt_t1)] <- df_model$pr_tt2_t1
df_model$pr_tt_t1[df_model$treat_time_t1_v1 == "8 or more months" & is.na(df_model$pr_tt_t1)] <- df_model$pr_tt3_t1
df_model$pr_tt_t1[df_model$treat_time_t1_v1 == "Currently in treatment" & is.na(df_model$pr_tt_t1)] <- df_model$pr_tt4_t1

# Descriptive
hist(df_model$pr_tt1_t1)
hist(df_model$pr_tt2_t1)
hist(df_model$pr_tt3_t1)
hist(df_model$pr_tt4_t1)
hist(df_model$pr_tt_t1)

summary(df_model$pr_tt1_t1)
summary(df_model$pr_tt2_t1)
summary(df_model$pr_tt3_t1)
summary(df_model$pr_tt4_t1)
summary(df_model$pr_tt_t1)

percentiles <- quantile(df_model$iptw_tt_t1, c(0, 0.02, 0.05, 0.1, 0.35, 0.5, 0.75, 0.9, 0.95, 0.98, 1), na.rm = T)
percentiles

# Save MICE
#save(imp_t, file = "imp_t_v2.Rda")
```

### Plot
```{r eval=FALSE}
# Look at the weights
summary(df_model$iptw_tt_t1)
hist(df_model$iptw_tt_t1, main = "IPTW Density", xlab = "IPTW", breaks = 300)
density_plot <- density(df_model$iptw_tt_t1)
plot(density_plot, main = "IPTW Treatment time T1 Density", xlab = "IPTW", col = "blue")

# Check density
density_plot_t1_1 <- density(df_model$iptw_tt_t1[df_model$treat_time_t1_v1 == "3 or less months"], na.rm = TRUE)
density_plot_t1_2 <- density(df_model$iptw_tt_t1[df_model$treat_time_t1_v1 == "4 to 7 months"], na.rm = TRUE)
density_plot_t1_3 <- density(df_model$iptw_tt_t1[df_model$treat_time_t1_v1 == "8 or more months"], na.rm = TRUE)
density_plot_t1_4 <- density(df_model$iptw_tt_t1[df_model$treat_time_t1_v1 == "Currently in treatment"], na.rm = TRUE)

# Plot 
plot(density_plot_t1_1, main = "IPTW time in treatment T1 Density by treatment status", xlab = "IPTW", col = "blue", ylim = c(0, 1.5), xlim = c(0,max(df_model$iptw_tt_t1)))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
lines(density_plot_t1_4, col = "gold")
legend("topright", legend = c("0 to 3", "4 to 7", "8 or more", "Currently in treatment"), col = c("blue", "red", "green", "gold"), lty = 1)

# Probability tt == 1 / 3 or less months 
summary(df_model$pr_tt1_t1)

density_plot <- density(df_model$pr_tt1_t1)
plot(density_plot, main = "Pr 3 or less months T1 Density", xlab = "Probability Not Completed treatment", col = "blue", xlim = c(0,1))

# Check density
density_plot_t1_1 <- density(df_model$pr_tt1_t1[df_model$treat_time_t1_v1 == "3 or less months"], na.rm = TRUE)
density_plot_t1_2 <- density(df_model$pr_tt1_t1[df_model$treat_time_t1_v1 == "4 to 7 months"], na.rm = TRUE)
density_plot_t1_3 <- density(df_model$pr_tt1_t1[df_model$treat_time_t1_v1 == "8 or more months"], na.rm = TRUE)
density_plot_t1_4 <- density(df_model$pr_tt1_t1[df_model$treat_time_t1_v1 == "Currently in treatment"], na.rm = TRUE)

# Plot 
plot(density_plot_t1_1, main = "Pr 3 or less months T1 Density by treatment status", xlab = "Probability 3 or less months", col = "blue", xlim = c(0,1))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
lines(density_plot_t1_4, col = "gold")
legend("topright", legend = c("0 to 3", "4 to 7", "8 or more", "Currently in treatment"), col = c("blue", "red", "green", "gold"), lty = 1)

# Probability tt == 2 / 4 to 7 months
summary(df_model$pr_tt2_t1)

density_plot <- density(df_model$pr_tt2_t1)
plot(density_plot, main = "Pr 4 to 7 months T1 Density", xlab = "Probability 4 to 7 months", col = "blue", xlim = c(0,1))

# Check density
density_plot_t1_1 <- density(df_model$pr_tt2_t1[df_model$treat_time_t1_v1 == "3 or less months"], na.rm = TRUE)
density_plot_t1_2 <- density(df_model$pr_tt2_t1[df_model$treat_time_t1_v1 == "4 to 7 months"], na.rm = TRUE)
density_plot_t1_3 <- density(df_model$pr_tt2_t1[df_model$treat_time_t1_v1 == "8 or more months"], na.rm = TRUE)
density_plot_t1_4 <- density(df_model$pr_tt2_t1[df_model$treat_time_t1_v1 == "Currently in treatment"], na.rm = TRUE)

# Plot 
plot(density_plot_t1_1, main = "Pr 4 to 7 months T1 Density by treatment status", xlab = "Probability 4 to 7 months", col = "blue", xlim = c(0,1))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
lines(density_plot_t1_4, col = "gold")
legend("topright", legend = c("0 to 3", "4 to 7", "8 or more", "Currently in treatment"), col = c("blue", "red", "green", "gold"), lty = 1)

# Probability tt == 3 / 8 or more months
summary(df_model$pr_tt3_t1)

density_plot <- density(df_model$pr_tt3_t1)
plot(density_plot, main = "Pr 8 or more months T1 Density", xlab = "Probability 8 or more months", col = "blue", xlim = c(0,1))

# Check density
density_plot_t1_1 <- density(df_model$pr_tt3_t1[df_model$treat_time_t1_v1 == "3 or less months"], na.rm = TRUE)
density_plot_t1_2 <- density(df_model$pr_tt3_t1[df_model$treat_time_t1_v1 == "4 to 7 months"], na.rm = TRUE)
density_plot_t1_3 <- density(df_model$pr_tt3_t1[df_model$treat_time_t1_v1 == "8 or more months"], na.rm = TRUE)
density_plot_t1_4 <- density(df_model$pr_tt3_t1[df_model$treat_time_t1_v1 == "Currently in treatment"], na.rm = TRUE)

# Plot 
plot(density_plot_t1_1, main = "Pr 8 or more months T1 Density by treatment status", xlab = "Probability 8 or more months", col = "blue", xlim = c(0,1))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
lines(density_plot_t1_4, col = "gold")
legend("topright", legend = c("0 to 3", "4 to 7", "8 or more", "Currently in treatment"), col = c("blue", "red", "green", "gold"), lty = 1)

# Probability tt == 4 / Currently in treatment
summary(df_model$pr_tt4_t1)

density_plot <- density(df_model$pr_tt4_t1)
plot(density_plot, main = "Pr  Currently in treatment T1 Density", xlab = "Probability  Currently in treatment", col = "blue", xlim = c(0,1))

# Check density
density_plot_t1_1 <- density(df_model$pr_tt4_t1[df_model$treat_time_t1_v1 == "3 or less months"], na.rm = TRUE)
density_plot_t1_2 <- density(df_model$pr_tt4_t1[df_model$treat_time_t1_v1 == "4 to 7 months"], na.rm = TRUE)
density_plot_t1_3 <- density(df_model$pr_tt4_t1[df_model$treat_time_t1_v1 == "8 or more months"], na.rm = TRUE)
density_plot_t1_4 <- density(df_model$pr_tt4_t1[df_model$treat_time_t1_v1 == "Currently in treatment"], na.rm = TRUE)

# Plot 
plot(density_plot_t1_1, main = "Pr Currently in treatment T1 Density by treatment status", xlab = "Probability  Currently in treatment", col = "blue", xlim = c(0,1))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
lines(density_plot_t1_4, col = "gold")
legend("topright", legend = c("0 to 3", "4 to 7", "8 or more", "Currently in treatment"), col = c("blue", "red", "green", "gold"), lty = 1)

# All probabilities
density_plot_t1_1 <- density(df_model$pr_tt1_t1, na.rm = TRUE)
density_plot_t1_2 <- density(df_model$pr_tt2_t1, na.rm = TRUE)
density_plot_t1_3 <- density(df_model$pr_tt3_t1, na.rm = TRUE)
density_plot_t1_4 <- density(df_model$pr_tt4_t1, na.rm = TRUE)

plot(density_plot_t1_1, main = "Pr time in treatment at T1 Density", xlab = "Probability time in treatment at T1", col = "blue", xlim = c(0,1))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
lines(density_plot_t1_4, col = "gold")
legend("topright", legend = c("0 to 3", "4 to 7", "8 or more", "Currently in treatment"), col = c("blue", "red", "green", "gold"), lty = 1)

# Pr actual treatment
density_plot_t1_1 <- density(df_model$pr_tt_t1[df_model$treat_time_t1_v1 == "3 or less months"], na.rm = TRUE, bw = 0.01)
density_plot_t1_2 <- density(df_model$pr_tt_t1[df_model$treat_time_t1_v1 == "4 to 7 months"], na.rm = TRUE, bw = 0.01)
density_plot_t1_3 <- density(df_model$pr_tt_t1[df_model$treat_time_t1_v1 == "8 or more months"], na.rm = TRUE, bw = 0.01)
density_plot_t1_4 <- density(df_model$pr_tt_t1[df_model$treat_time_t1_v1 == "Currently in treatment"], na.rm = TRUE, bw = 0.01)

plot(density_plot_t1_1, main = "Pr actual treatment (time in) at T1 Density", xlab = "Probability time in treatment received at T1", col = "blue", xlim = c(0,1), ylim = c(0,5))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
lines(density_plot_t1_4, col = "gold")
legend("topright", legend = c("0 to 3", "4 to 7", "8 or more", "Currently in treatment"), col = c("blue", "red", "green", "gold"), lty = 1)
```

### Extract iptw for outcome regression
```{r eval=FALSE}
df_iptw_t1 <- df_model[,c("folio","iptw_tt_t1","pr_tt1_t1","pr_tt2_t1","pr_tt3_t1","pr_tt4_t1","pr_tt_t1")]
save(df_iptw_t1, file = "df_iptw_tt_t1_v2.Rdata")
```

## Merge df_outcome with weights
```{r}
load(file = "df_ipcw_t2_v2.Rdata")
load(file = "df_iptw_tt_t1_v2.Rdata")

df_outcome <- df_tables
# IPCW
df_outcome <- merge(df_outcome,df_ipcw_t2,by="folio", all = T) 

# IPTW
df_outcome <- merge(df_outcome,df_iptw_t1,by="folio", all = T) 

sd(df_outcome$iptw_tt_t1, na.rm = T)
sd(df_outcome$ipcw_t2)
```

### Standardized mean differences IPTW weights
```{r eval=FALSE}
## Create a variable list
vars <- c("treat_time_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")

# IPCW
df_outcome <- df_outcome[!is.na(df_outcome$iptw_tt_t1), ]

tabNot <- CreateTableOne(vars = vars, strata = c("treat_time_t1_v1"), smd = T, data = df_outcome)

# Create weighted data
df_outcome_Svy <- svydesign(ids = ~ 1, data = df_outcome, weights = ~ iptw_tt_t1)

## Create Table 1 stratified by trt
tabWeighted <- svyCreateTableOne(vars = vars, strata = c("treat_time_t1_v1"), data = df_outcome_Svy, test = FALSE)

## Just typing the object name will invoke the print.TableOne method
print(tabNot, smd = TRUE, labels = mylabels)
print(tabWeighted, smd = TRUE, labels = mylabels)
```

## Final weights and trimmed
```{r}
# Filter to those with weights
df_outcome <- df_outcome[complete.cases(df_outcome$iptw_tt_t1), ]

# Construct final weights
df_outcome$w_t <- df_outcome$ipcw_t2*df_outcome$iptw_tt_t1

# Trimm the weights 2-98
df_outcome$w_t_298 <- df_outcome$w_t                                          
percentiles <- quantile(df_outcome$w_t_298, c(0.02, 0.98), na.rm = T)
percentiles
df_outcome$w_t_298[df_outcome$w_t <= percentiles[1]] <- NA

df_outcome$w_t_298[df_outcome$w_t >= percentiles[2]] <- NA

sd(df_outcome$w_t)
summary(df_outcome$w_t_298)
```

### Plots
```{r eval=FALSE}
# Plot
density_plot <- density(df_outcome$w_t)
plot(density_plot, main = "IPCW*IPTW time in Tx Density", xlab = "IPCW*IPTW", col = "blue")

# Check density across censored and uncensored T2
density_plot_t1_1 <- density(df_outcome$w_t[df_outcome$treat_time_t1_v1 == "3 or less months"], na.rm = TRUE)
density_plot_t1_2 <- density(df_outcome$w_t[df_outcome$treat_time_t1_v1 == "4 to 7 months"], na.rm = TRUE)
density_plot_t1_3 <- density(df_outcome$w_t[df_outcome$treat_time_t1_v1 == "8 or more months"], na.rm = TRUE)
density_plot_t1_4 <- density(df_outcome$w_t[df_outcome$treat_time_t1_v1 == "Currently in treatment"], na.rm = TRUE)

# Plot 
plot(density_plot_t1_1, main = "IPCW*IPTW time in Tx by treatment status", xlab = "IPCW*IPTW", col = "blue", ylim = c(0, 1.2), xlim = c(0,max(df_outcome$iptw_tt_t1)))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
lines(density_plot_t1_4, col = "gold")
legend("topright", legend = c("0 to 3", "4 to 7", "8 or more", "Currently in treatment"), col = c("blue", "red", "green", "gold"), lty = 1)
```

#### Trimmed
```{r eval=FALSE}
# Plot
density_plot <- density(df_outcome$w_t_298, na.rm = T)
plot(density_plot, main = "IPCW*IPTW time in Tx Density", xlab = "IPCW*IPTW", col = "blue")

# Check density across censored and uncensored T2
density_plot_t1_1 <- density(df_outcome$w_t_298[df_outcome$treat_time_t1_v1 == "3 or less months"], na.rm = TRUE)
density_plot_t1_2 <- density(df_outcome$w_t_298[df_outcome$treat_time_t1_v1 == "4 to 7 months"], na.rm = TRUE)
density_plot_t1_3 <- density(df_outcome$w_t_298[df_outcome$treat_time_t1_v1 == "8 or more months"], na.rm = TRUE)
density_plot_t1_4 <- density(df_outcome$w_t_298[df_outcome$treat_time_t1_v1 == "Currently in treatment"], na.rm = TRUE)

# Plot 
plot(density_plot_t1_1, main = "IPCW*IPTW time in Tx by treatment status", 
     xlab = "IPCW*IPTW", col = "blue", ylim = c(0, 1.5), xlim = c(0,max(df_outcome$w_t_298, na.rm = T)))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
lines(density_plot_t1_4, col = "gold")
legend("topright", legend = c("0 to 3", "4 to 7", "8 or more", "Currently in treatment"), col = c("blue", "red", "green", "gold"), lty = 1)


# Pr actual treatment
density_plot_t1_1 <- density(df_outcome$pr_tt_t1[df_outcome$treat_time_t1_v1 == "3 or less months" & !is.na(df_outcome$w_t_298)], na.rm = TRUE, bw = 0.01)
density_plot_t1_2 <- density(df_outcome$pr_tt_t1[df_outcome$treat_time_t1_v1 == "4 to 7 months" & !is.na(df_outcome$w_t_298)], na.rm = TRUE, bw = 0.01)
density_plot_t1_3 <- density(df_outcome$pr_tt_t1[df_outcome$treat_time_t1_v1 == "8 or more months" & !is.na(df_outcome$w_t_298)], na.rm = TRUE, bw = 0.01)
density_plot_t1_4 <- density(df_outcome$pr_tt_t1[df_outcome$treat_time_t1_v1 == "Currently in treatment" & !is.na(df_outcome$w_t_298)], na.rm = TRUE, bw = 0.01)

# Plot 
plot(density_plot_t1_1, main = "Pr actual treatment (time in) at T1 Density trimmed", 
     xlab = "Probability time in treatment received at T1", col = "blue", ylim = c(0, 5.5), xlim = c(0,1))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
lines(density_plot_t1_4, col = "gold")
legend("topright", legend = c("0 to 3", "4 to 7", "8 or more", "Currently in treatment"), col = c("blue", "red", "green", "gold"), lty = 1)
```

### Table weights
```{r eval=FALSE}
weights <- tableby(treat_time_t1_v1 ~ pr_notcen_t2 + ipcw_t2 + pr_tt1_t1 + pr_tt2_t1 + pr_tt3_t1 + pr_tt4_t1 + iptw_tt_t1 + w_t + w_t_298, 
                  data = df_outcome, numeric.stats=c("mean", "sd", 
                                                    "medianq1q3", 
                                                    "min", "max", "Nmiss", "N"),
                  digits=1, digits.p=3, digits.pct=1, na.action(TRUE))

summary(weights, labelTranslations = mylabels, text=TRUE)

percentiles <- quantile(df_outcome$ipcw_t2, c(0, 0.02, 0.05, 0.1, 0.35, 0.5, 0.75, 0.9, 0.95, 0.98, 1), na.rm = T)
percentiles

percentiles <- quantile(df_outcome$iptw_tt_t1, c(0, 0.02, 0.05, 0.1, 0.35, 0.5, 0.75, 0.9, 0.95, 0.98, 1), na.rm = T)
percentiles

percentiles <- quantile(df_outcome$w_t, c(0, 0.02, 0.05, 0.1, 0.35, 0.5, 0.75, 0.9, 0.95, 0.98, 1), na.rm = T)
percentiles

summary(df_outcome$w_t)
```

## Standardized mean differences
```{r eval=FALSE}
# Final weights
## Create a variable list
vars <- c("treat_time_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")

df_outcome <- df_outcome[!is.na(df_outcome$w_t), ]

# Create weighted data
df_outcome_Svy <- svydesign(ids = ~ 1, data = df_outcome, weights = ~ w_t)

## Create Table 1 stratified by trt
tabWeighted <- svyCreateTableOne(vars = vars, strata = c("treat_time_t1_v1"), data = df_outcome_Svy, test = FALSE)

## Just typing the object name will invoke the print.TableOne method
print(tabWeighted, smd = TRUE, labels = mylabels)

# Trimmed weights
## Create a variable list
vars <- c("treat_time_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")

df_outcome <- df_outcome[!is.na(df_outcome$w_t_298), ]

# Create weighted data
df_outcome_Svy <- svydesign(ids = ~ 1, data = df_outcome, weights = ~ w_t_298)

## Create Table 1 stratified by trt
tabWeighted <- svyCreateTableOne(vars = vars, strata = c("treat_time_t1_v1"), data = df_outcome_Svy, test = FALSE)

## Just typing the object name will invoke the print.TableOne method
print(tabWeighted, smd = TRUE, labels = mylabels)
```

## Filter by common support area - Sensitivity 3
```{r eval=FALSE}
# maximum minimum 4-7 months 0.052
# minimum maximum 8+ months 0.677

df_outcome <- subset(df_outcome, pr_tt_t1 > 0.052 & pr_tt_t1 < 0.677) # 20 less cases
```

## Outcome model: Time in treatment

### Substance use: primary substance
```{r eval=FALSE}
# Creating dataset
df_sp <- df_outcome

complete_cases <- complete.cases(df_sp$sp_mprev_t2, df_sp$t2==1)
df_complete_cases <- df_sp[complete_cases, ]

df_complete_cases$sp_mprev_t2 <- as.numeric(df_complete_cases$sp_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("sp_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_sp1 <- glm(sp_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases)

t_m_sp1 <- tbl_regression(m_sp1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

# 7 Adjusted trimmed weights
m_sp7 <- geeglm(sp_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                id = folio,
                weights = w_t_298)

t_m_sp7 <-  tbl_regression(m_sp7, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

#### MICE
```{r eval=FALSE}
df_model <- df_sp

# MICE
df_model <- df_model[c("folio", "ipcw_t2",
                   "sp_mprev_t2",
                   "treat_time_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")] # Disruptive events, For-profit crimes and ACEs 

complete_cases <- complete.cases(df_model$sp_mprev_t2)
df_model <- df_model[complete_cases, ]

p_missing <- unlist(lapply(df_model, function(x) sum(is.na(x))))/nrow(df_model)
round(sort(p_missing[p_missing > 0], decreasing = TRUE)*100,2)

# Run the mice code with 0 iterations 
imp <- mice(df_model, maxit=0)

# Extract predictorMatrix and methods of imputation 
predM <- imp$predictorMatrix
meth <- imp$method

# Setting values of variables I'd like to leave out to 0 in the predictor matrix
predM[, c("folio")] <- 0

# Specify a separate imputation model for variables of interest 

# Numerical variables
num <- c("readi", "ratio", "net_index_t0", "victnna_num")

# Dichotomous variable
log <- c("tto_primertrata_t0", "tbjo_t0", "pb_mprev_t0", 
         "drgs_ini", "p42", "tranq_mprev_t0" , "tto_30dias_t0" , "redes_vivedrogas_t0" , "mar_mprev_t0" , "sld_mini_antisoc_t0" )

# Ordered categorical variables 
poly <- c("educ_nivel2_t0")

# Unordered categorical variable 
poly2 <- c("prev_tto")

# Turn their methods matrix into the specified imputation models
meth[num] <- "norm.boot"
meth[log] <- "logreg.boot"
meth[poly] <- "polyreg"
meth[poly2] <- "polyreg"

# MICE
set.seed(12345)
imp2 <- mice(df_model, 
             m = 30,
             maxit = 10, 
             predictorMatrix = predM, 
             method = meth,
             print = FALSE)


set.seed(12345)
m_sp3 <- with(imp2,
            glm(sp_mprev_t2 ~ treat_time_t1_v1 +
                    tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + 
                    pb_mprev_t0 + tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini + drgs_sp_t0 + # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 + # Family and cohabitation
                    peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor +  + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0 + victnna_num,
                family = binomial(),
                data = df_model))

mice_rr <- avg_comparisons(m_sp3, comparison = "ratio", variables = "treat_time_t1_v1")

print(mice_rr, style = "data.frame")

data.frame(p)

t_m_sp3 <-  tbl_regression(m_sp3, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

```

#### Tables
```{r eval=FALSE}
t_m_sp1 
t_m_sp3 
t_m_sp7

nobs(m_sp1)
nobs(m_sp7)
```

```{r}
# Create a list of your t_m_sp objects
t_m_sp_list <- list(t_m_sp1, t_m_sp3, t_m_sp7)

# Loop 
for (i in seq_along(t_m_sp_list)) {
  # Create the gtsummary table 
  table_for_current_dataset <- t_m_sp_list[[i]] %>%
    gtsummary::as_gt()

  # Save 
  gt::gtsave(table_for_current_dataset, file = sprintf("sp_model_%d.rtf", i))
}
```

### Substance use: alcohol
```{r eval=FALSE}
# Creating dataset
df_oh <- df_outcome
complete_cases <- complete.cases(df_oh$alco_mprev_t2, df_oh$t2==1)
df_complete_cases <- df_oh[complete_cases, ]

df_complete_cases$alco_mprev_t2 <- as.numeric(df_complete_cases$alco_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("alco_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_oh1 <- glm(alco_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases)


t_m_oh1 <- tbl_regression(m_oh1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

# 7 Adjusted trimmed weights
m_oh7 <- geeglm(alco_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                id = folio,
                weights = w_t_298)

t_m_oh7 <-  tbl_regression(m_oh7, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

#### MICE
```{r eval=FALSE}
df_model <- df_oh

# MICE
df_model <- df_model[c("folio", "ipcw_t2",
                   "alco_mprev_t2",
                   "treat_time_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")] # Disruptive events, For-profit crimes and ACEs    

complete_cases <- complete.cases(df_model$alco_mprev_t2)
df_model <- df_model[complete_cases, ]

p_missing <- unlist(lapply(df_model, function(x) sum(is.na(x))))/nrow(df_model)
round(sort(p_missing[p_missing > 0], decreasing = TRUE)*100,2)

# Run the mice code with 0 iterations 
imp <- mice(df_model, maxit=0)

# Extract predictorMatrix and methods of imputation 
predM <- imp$predictorMatrix
meth <- imp$method

# Setting values of variables I'd like to leave out to 0 in the predictor matrix
predM[, c("folio")] <- 0

# Specify a separate imputation model for variables of interest 

# Numerical variables
num <- c("readi", "ratio", "net_index_t0", "victnna_num")

# Dichotomous variable
log <- c("tto_primertrata_t0", "tbjo_t0", "pb_mprev_t0", "p42", 
         "mar_mprev_t0", "coc_mprev_t0", "drgs_ini", "tranq_mprev_t0", 
         "tto_30dias_t0", "redes_vivedrogas_t0", "sld_mini_antisoc_t0")

# Ordered categorical variables tranq_mprev_t0
poly <- c("educ_nivel2_t0")

# Unordered categorical variable 
poly2 <- c("prev_tto")

# Turn their methods matrix into the specified imputation models
meth[num] <- "norm.boot"
meth[log] <- "logreg.boot"
meth[poly] <- "polyreg"
meth[poly2] <- "polyreg"

# MICE
set.seed(12345)
imp2 <- mice(df_model, 
             m = 30,
             maxit = 10, 
             predictorMatrix = predM, 
             method = meth,
             print = FALSE)

set.seed(12345)
m_oh3 <- with(imp2,
            glm(alco_mprev_t2 ~ treat_time_t1_v1 +
                             tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + 
                    pb_mprev_t0 + tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini +  drgs_sp_t0 + # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 + # Family and cohabitation
                    peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor +  + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0 + victnna_num,  
                 data = df_model, family = binomial))

mice_rr <- avg_comparisons(m_oh3, comparison = "ratio", variables = "treat_time_t1_v1")

print(mice_rr, style = "data.frame")

t_m_oh3 <-  tbl_regression(m_oh3, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

#### Tables
```{r eval=FALSE}
t_m_oh1 
t_m_oh3
t_m_oh7

nobs(m_oh1)
nobs(m_oh7)
```

```{r eval=FALSE}
# Create a list of your t_m_oh objects
t_m_oh_list <- list(t_m_oh1, t_m_oh3, t_m_oh7)

# Loop 
for (i in seq_along(t_m_oh_list)) {
  # Create the gtsummary table 
  table_for_current_dataset <- t_m_oh_list[[i]] %>%
    gtsummary::as_gt()

  # Save 
  gt::gtsave(table_for_current_dataset, file = sprintf("oh_model_%d.rtf", i))
}
```

### Substance use: cannabis
```{r eval=FALSE}
# Creating dataset
df_mar <- df_outcome

complete_cases <- complete.cases(df_mar$mar_mprev_t2, df_mar$t2==1)
df_complete_cases <- df_mar[complete_cases, ]

df_complete_cases$mar_mprev_t2 <- as.numeric(df_complete_cases$mar_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("mar_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_mar1 <- glm(mar_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases)


t_m_mar1 <- tbl_regression(m_mar1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

# 7 Adjusted trimmed weights
m_mar7 <- geeglm(mar_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                id = folio,
                weights = w_t_298)

t_m_mar7 <-  tbl_regression(m_mar7, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

#### MICE
```{r eval=FALSE}
df_model <- df_mar

# MICE
df_model <- df_model[c("folio", "ipcw_t2",
                   "mar_mprev_t2",
                   "treat_time_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")] # Disruptive events, For-profit crimes and ACEs      

complete_cases <- complete.cases(df_model$mar_mprev_t2)
df_model <- df_model[complete_cases, ]

p_missing <- unlist(lapply(df_model, function(x) sum(is.na(x))))/nrow(df_model)
round(sort(p_missing[p_missing > 0], decreasing = TRUE)*100,2)

# Run the mice code with 0 iterations 
imp <- mice(df_model, maxit=0)

# Extract predictorMatrix and methods of imputation 
predM <- imp$predictorMatrix
meth <- imp$method

# Setting values of variables I'd like to leave out to 0 in the predictor matrix
predM[, c("folio")] <- 0

# Specify a separate imputation model for variables of interest 

# Numerical variables
num <- c("readi", "ratio", "net_index_t0", "victnna_num")

# Dichotomous variable
log <- c("tto_primertrata_t0", "tbjo_t0", "pb_mprev_t0", "p42",
         "coc_mprev_t0", "drgs_ini", "tranq_mprev_t0", "tto_30dias_t0", "redes_vivedrogas_t0", "sld_mini_antisoc_t0")

# Ordered categorical variables tranq_mprev_t0
#poly <- c("")

# Unordered categorical variable 
poly2 <- c("prev_tto")

# Turn their methods matrix into the specified imputation models
meth[num] <- "norm.boot"
meth[log] <- "logreg.boot"
meth[poly] <- "polyreg"
meth[poly2] <- "polyreg"

# MICE
set.seed(12345)
imp2 <- mice(df_model, 
             m = 30,
             maxit = 10, 
             predictorMatrix = predM, 
             method = meth,
             print = FALSE)

set.seed(12345)
m_mar3 <- with(imp2,
            glm(mar_mprev_t2 ~ treat_time_t1_v1 +
                             tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + coc_mprev_t0 + 
                    pb_mprev_t0 + tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini +  drgs_sp_t0 + # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 + # Family and cohabitation
                    peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor +  + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0 + victnna_num,  
                 data = df_model, family = binomial))

mice_rr <- avg_comparisons(m_mar3, comparison = "ratio", variables = "treat_time_t1_v1")

print(mice_rr, style = "data.frame")

t_m_mar3 <-  tbl_regression(m_mar3, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")            
```

#### Tables
```{r eval=FALSE}
t_m_mar1 
t_m_mar3 
t_m_mar7
```

```{r eval=FALSE}
# Create a list of your t_m_mar objects
t_m_mar_list <- list(t_m_mar1, t_m_mar3, t_m_mar7)

# Loop 
for (i in seq_along(t_m_mar_list)) {
  # Create the gtsummary table 
  table_for_current_dataset <- t_m_mar_list[[i]] %>%
    gtsummary::as_gt()

  # Save 
  gt::gtsave(table_for_current_dataset, file = sprintf("mar_model_%d.rtf", i))
}
```

### Substance use: cocaine
```{r eval=FALSE}
# Creating dataset
df_coc <- df_outcome

complete_cases <- complete.cases(df_coc$coc_mprev_t2, df_coc$t2==1)
df_complete_cases <- df_coc[complete_cases, ]

df_complete_cases$coc_mprev_t2 <- as.numeric(df_complete_cases$coc_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("coc_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_coc1 <- glm(coc_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases)

t_m_coc1 <- tbl_regression(m_coc1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

# 7 Adjusted trimmed weights
m_coc7 <- geeglm(coc_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                id = folio,
                weights = w_t_298)

t_m_coc7 <-  tbl_regression(m_coc7, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

#### MICE
```{r eval=FALSE}
df_model <- df_coc

# MICE
df_model <- df_model[c("folio", "ipcw_t2",
                   "coc_mprev_t2",
                   "treat_time_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")] # Disruptive events, For-profit crimes and ACEs     

complete_cases <- complete.cases(df_model$coc_mprev_t2)
df_model <- df_model[complete_cases, ]

p_missing <- unlist(lapply(df_model, function(x) sum(is.na(x))))/nrow(df_model)
round(sort(p_missing[p_missing > 0], decreasing = TRUE)*100,2)

# Run the mice code with 0 iterations 
imp <- mice(df_model, maxit=0)

# Extract predictorMatrix and methods of imputation 
predM <- imp$predictorMatrix
meth <- imp$method

# Setting values of variables I'd like to leave out to 0 in the predictor matrix
predM[, c("folio")] <- 0

# Specify a separate imputation model for variables of interest 

# Numerical variables
num <- c("readi", "ratio", "net_index_t0", "victnna_num")

# Dichotomous variable
log <- c("tto_primertrata_t0", "tbjo_t0", "pb_mprev_t0", "p42", 
         "tranq_mprev_t0", "drgs_ini", "tto_30dias_t0", "sld_mini_antisoc_t0", "redes_vivedrogas_t0")

# Ordered categorical variables tranq_mprev_t0
#poly <- c("aces", "educ_nivel2_t0")
               
# Unordered categorical variable 
poly2 <- c("prev_tto")

# Turn their methods matrix into the specified imputation models
meth[num] <- "norm.boot"
meth[log] <- "logreg.boot"
meth[poly] <- "polyreg"
meth[poly2] <- "polyreg"

# MICE
set.seed(12345)
imp2 <- mice(df_model, 
             m = 30,
             maxit = 10, 
             predictorMatrix = predM, 
             method = meth,
             print = FALSE)

set.seed(12345)
m_coc3 <- with(imp2,
            glm(coc_mprev_t2 ~ treat_time_t1_v1 +
                             tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + 
                    pb_mprev_t0 + tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini + drgs_sp_t0 + # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 + # Family and cohabitation
                    peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor +  + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0 + victnna_num,  
                 data = df_model, family = binomial))

mice_rr <- avg_comparisons(m_coc3, comparison = "ratio", variables = "treat_time_t1_v1")

print(mice_rr, style = "data.frame")

t_m_coc3 <-  tbl_regression(m_coc3, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")            
```

#### Tables
```{r eval=FALSE}
t_m_coc1 
t_m_coc3 
t_m_coc7
```

```{r eval=FALSE}
# Create a list of your t_m_coc objects
t_m_coc_list <- list(t_m_coc1, t_m_coc3, t_m_coc7)

# Loop 
for (i in seq_along(t_m_coc_list)) {
  # Create the gtsumcocy table 
  table_for_current_dataset <- t_m_coc_list[[i]] %>%
    gtsummary::as_gt()

  # Save 
  gt::gtsave(table_for_current_dataset, file = sprintf("coc_model_%d.rtf", i))
}
```

### Substance use: cocaine paste
```{r eval=FALSE}
# Creating dataset
df_pb <- df_outcome

complete_cases <- complete.cases(df_pb$pb_mprev_t2, df_pb$t2==1)
df_complete_cases <- df_pb[complete_cases, ]

df_complete_cases$pb_mprev_t2 <- as.numeric(df_complete_cases$pb_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("pb_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_pb1 <- glm(pb_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases)

t_m_pb1 <- tbl_regression(m_pb1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

# 7 Adjusted trimmed weights
m_pb7 <- geeglm(pb_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                id = folio,
                weights = w_t_298)

t_m_pb7 <-  tbl_regression(m_pb7, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

#### MICE
```{r eval=FALSE}
df_model <- df_pb

# MICE
df_model <- df_model[c("folio", "ipcw_t2",
                   "pb_mprev_t2",
                   "treat_time_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")] # Disruptive events, For-profit crimes and ACEs       

complete_cases <- complete.cases(df_model$pb_mprev_t2)
df_model <- df_model[complete_cases, ]

p_missing <- unlist(lapply(df_model, function(x) sum(is.na(x))))/nrow(df_model)
round(sort(p_missing[p_missing > 0], decreasing = TRUE)*100,2)

# Run the mice code with 0 iterations 
imp <- mice(df_model, maxit=0)

# Extract predictorMatrix and methods of imputation 
predM <- imp$predictorMatrix
meth <- imp$method

# Setting values of variables I'd like to leave out to 0 in the predictor matrix
predM[, c("folio")] <- 0

# Specify a separate imputation model for variables of interest 

# Numerical variables
num <- c("readi", "ratio", "net_index_t0", "victnna_num")

# Dichotomous variable
log <- c("tto_primertrata_t0", "tbjo_t0", "redes_vivedrogas_t0", "tranq_mprev_t0", 
         "drgs_ini", "tto_30dias_t0", "coc_mprev_t0", "sld_mini_antisoc_t0", "p42")

# Ordered categorical variables tranq_mprev_t0
poly <- c("educ_nivel2_t0")

# Unordered categorical variable 
poly2 <- c("prev_tto")

# Turn their methods matrix into the specified imputation models
meth[num] <- "norm.boot"
meth[log] <- "logreg.boot"
meth[poly] <- "polyreg"
meth[poly2] <- "polyreg"

# MICE
set.seed(12345)
imp2 <- mice(df_model, 
             m = 30,
             maxit = 10, 
             predictorMatrix = predM, 
             method = meth,
             print = FALSE)

set.seed(12345)
m_pb3 <- with(imp2,
            glm(pb_mprev_t2 ~ treat_time_t1_v1 +
                             tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + 
                    tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini + drgs_sp_t0 + # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 + # Family and cohabitation
                    peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor +  + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0 + victnna_num,  
                 data = df_model, family = binomial))

mice_rr <- avg_comparisons(m_pb3, comparison = "ratio", variables = "treat_time_t1_v1")

print(mice_rr, style = "data.frame")

t_m_pb3 <-  tbl_regression(m_pb3, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")            
```

#### Tables
```{r eval=FALSE}
t_m_pb1 
t_m_pb3 
t_m_pb7
```

```{r eval=FALSE}
# Create a list of your t_m_pb objects
t_m_pb_list <- list(t_m_pb1, t_m_pb3, t_m_pb7)

# Loop 
for (i in seq_along(t_m_pb_list)) {
  # Create the gtsumpby table 
  table_for_current_dataset <- t_m_pb_list[[i]] %>%
    gtsummary::as_gt()

  # Save 
  gt::gtsave(table_for_current_dataset, file = sprintf("pb_model_%d.rtf", i))
}
```

### Psychiatric comorbidities
```{r eval=FALSE}
# Creating dataset
df_psyc <- df_outcome

complete_cases <- complete.cases(df_psyc$psyc_comor_t2, df_psyc$t2==1)
df_complete_cases <- df_psyc[complete_cases, ]

df_complete_cases$psyc_comor_t2 <- as.numeric(df_complete_cases$psyc_comor_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("psyc_comor_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_psyc1 <- glm(psyc_comor_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases)

t_m_psyc1 <- tbl_regression(m_psyc1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

# 7 Adjusted trimmed weights
m_psyc7 <- geeglm(psyc_comor_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                id = folio,
                weights = w_t_298)

t_m_psyc7 <-  tbl_regression(m_psyc7, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

```

#### MICE
```{r eval=FALSE}
df_model <- df_psyc

# MICE
df_model <- df_model[c("folio", "ipcw_t2",
                   "psyc_comor_t2",
                   "treat_time_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0",  "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")] # Disruptive events, For-profit crimes and ACEs     

complete_cases <- complete.cases(df_model$psyc_comor_t2)
df_model <- df_model[complete_cases, ]

p_missing <- unlist(lapply(df_model, function(x) sum(is.na(x))))/nrow(df_model)
round(sort(p_missing[p_missing > 0], decreasing = TRUE)*100,2)

# Run the mice code with 0 iterations 
imp <- mice(df_model, maxit=0)

# Extract predictorMatrix and methods of imputation 
predM <- imp$predictorMatrix
meth <- imp$method

# Setting values of variables I'd like to leave out to 0 in the predictor matrix
predM[, c("folio")] <- 0

# Specify a separate imputation model for variables of interest 

# Numerical variables
num <- c("readi", "ratio", "net_index_t0", "victnna_num")

# Dichotomous variable
log <- c("tto_primertrata_t0", "tbjo_t0", "pb_mprev_t0", "tranq_mprev_t0", 
         "drgs_ini", "tto_30dias_t0", "redes_vivedrogas_t0", "mar_mprev_t0", "p42", "coc_mprev_t0", "sld_mini_antisoc_t0")

# Ordered categorical variables tranq_mprev_t0
poly <- c("educ_nivel2_t0")

# Unordered categorical variable 
poly2 <- c("prev_tto")

# Turn their methods matrix into the specified imputation models
meth[num] <- "norm.boot"
meth[log] <- "logreg.boot"
meth[poly] <- "polyreg"
meth[poly2] <- "polyreg"

# MICE
set.seed(12345)
imp2 <- mice(df_model, 
             m = 30,
             maxit = 10, 
             predictorMatrix = predM, 
             method = meth,
             print = FALSE)

set.seed(12345)
m_psyc3 <- with(imp2,
            glm(psyc_comor_t2 ~ treat_time_t1_v1 +
                             tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + 
                    pb_mprev_t0 + tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini + drgs_sp_t0 +  # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 + # Family and cohabitation
                    peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor +  + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0 + victnna_num,  
                 data = df_model, family = binomial))

mice_rr <- avg_comparisons(m_psyc3, comparison = "ratio", variables = "treat_time_t1_v1")

print(mice_rr, style = "data.frame")

t_m_psyc3 <-  tbl_regression(m_psyc3, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")            
```

#### Tables
```{r eval=FALSE}
t_m_psyc1 
t_m_psyc3 
t_m_psyc7
```

```{r eval=FALSE}
# Create a list of your t_m_psyc objects
t_m_psyc_list <- list(t_m_psyc1, t_m_psyc3,  t_m_psyc7)

# Loop 
for (i in seq_along(t_m_psyc_list)) {
  # Create the gtsumpsycy table 
  table_for_current_dataset <- t_m_psyc_list[[i]] %>%
    gtsummary::as_gt()

  # Save 
  gt::gtsave(table_for_current_dataset, file = sprintf("psyc_model_%d.rtf", i))
}
```

# IPTW - Compliance with treatment

## Table
```{r eval=FALSE}
df_m <- df_outcome[df_outcome$t2==1,]

treat_2 <- tableby(treat_comp_t1_v1 ~ 
                     sp_mprev_t0 + sp_mprev_t2 +
                     alco_mprev_t0 + alco_mprev_t2 +
                     mar_mprev_t0 + mar_mprev_t2 +
                     coc_mprev_t0 + coc_mprev_t2 +
                     pb_mprev_t0 + pb_mprev_t2 + 
                       psyc_comor_t0 + sld_mini_depact_t0 + sld_mini_angusactual_t0 + sld_mini_tans_t0 + sld_mini_eept_t0 +
                       psyc_comor_t2 + sld_mini_depact_t2 + sld_mini_angusactual_t2 + sld_mini_tans_t2 + sld_mini_eept_t2 +
                       tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                       sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                       drgs_sp_t0 + drgs_polimes_t0 + tranq_mprev_t0 + drgs_ini + drgs_sp_t0 +  # Substance use
                       readi + # Motivation to change
                       prev_tto + tto_primertrata_t0 + # Prior treatment
                       redes_vivedrogas_t0 + net_index_t0 + # Family and cohabitation
                       peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                       phy_comor +  + sld_mini_antisoc_t0 + # Comorbidities
                       dis_event_t0 + fp_crime_t0 + aces + victnna_num,  # Disruptive events and For-profit crimes                       
                  data = df_m, numeric.stats=c("mean", "sd", "Nmiss", "N"),
                  digits=1, digits.p=3, digits.pct=1)

summary(treat_2, labelTranslations = mylabels, text=TRUE)
```

## Weights
```{r eval=FALSE}
df_outcome <- df_tables
# MICE
df_model <- df_outcome[c("folio", "t2", 
                   "treat_comp_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")] # Disruptive events, For-profit crimes and ACEs   

df_model <- df_model[df_model$t2==1,]
df_model <- df_model[complete.cases(df_model$treat_comp_t1_v1), ]

p_missing <- unlist(lapply(df_model, function(x) sum(is.na(x))))/nrow(df_model)
round(sort(p_missing[p_missing > 0], decreasing = TRUE)*100,2)

# Run the mice code with 0 iterations 
imp <- mice(df_model, maxit=0)

# Extract predictorMatrix and methods of imputation 
predM <- imp$predictorMatrix
meth <- imp$method

# Setting values of variables I'd like to leave out to 0 in the predictor matrix
predM[, c("folio")] <- 0

# Specify a separate imputation model for variables of interest 

# Numerical variables
num <- c("readi", "ratio", "net_index_t0", "victnna_num")

# Dichotomous variable
log <- c("p42","tranq_mprev_t0", "tbjo_t0", "pb_mprev_t0",
          "tto_30dias_t0", "drgs_ini", "redes_vivedrogas_t0",  "mar_mprev_t0", 
         "coc_mprev_t0", "tto_primertrata_t0", "sld_mini_antisoc_t0")

# Ordered categorical variables 
poly <- c("educ_nivel2_t0")

# Unordered categorical variable 
poly2 <- c("prev_tto")

# Turn their methods matrix into the specified imputation models
meth[num] <- "norm.boot"
meth[log] <- "logreg.boot"
meth[poly] <- "polyreg"
meth[poly2] <- "polyreg"

# MICE
set.seed(12345)
imp_c <- mice(df_model, 
             m = 30,
             maxit = 10, 
             predictorMatrix = predM, 
             method = meth,
             print = FALSE)

# Initialize list ipwpoint results
iptws_list <- list()

# Loop 
for (i in 1:30) {
  # Imputed dataset for the current iteration
  imp_data <- complete(imp_c, action = i)
  
  # Perform ipwpoint
  ipw_result <- ipwpoint(
    exposure = treat_comp_t1_v1,  
    family = "multinomial",
    numerator = ~ 1,
    denominator = ~ tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + 
                    pb_mprev_t0 + tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini + drgs_sp_t0 +  # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 + # Family and cohabitation
                    peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor +  + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0 + victnna_num,
    data = imp_data
  )
    
  # Store the ipcwpoint
  iptws_list[[i]] <- ipw_result
}

# Initialize a matrix to store IPCW results for each imputed dataset
iptws_matrix <- matrix(NA, nrow = nrow(df_model), ncol = 30)

# Loop over each imputed dataset
for (i in 1:30) {
  iptws_matrix[, i] <- iptws_list[[i]]$ipw.weights
}

# Calculate the mean IPCW across imputed datasets for each observation
df_model$iptw_tc_t1 <- rowMeans(iptws_matrix, na.rm = TRUE)

# Predicted probabilities
# Combine imputed datasets into a single dataset
complete_data <- mice::complete(imp_c, action = "long", include = TRUE)

# Perform logistic regression on the complete dataset
complete_model <- multinom(treat_comp_t1_v1 ~ 
                           tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + 
                    pb_mprev_t0 + tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini + drgs_sp_t0 +  # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 + # Family and cohabitation
                    peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor +  + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0 + victnna_num,  
                           data = complete_data)

# Predict probabilities for each observation in the combined dataset
predicted_probs <- fitted(complete_model, type = "response")

# Add folio variable to predicted_probs for comparison
predicted_probs_with_folio <- cbind(complete_data$folio, Predicted_Prob = predicted_probs[,1])

average_probs_by_folio <- aggregate(Predicted_Prob ~ V1, data = predicted_probs_with_folio, FUN = mean)

average_probs_by_folio <- average_probs_by_folio %>%
  rename(folio = V1)

df_model$pr_tc1_t1 <- average_probs_by_folio$Predicted_Prob

# Add folio variable to predicted_probs for comparison
predicted_probs_with_folio <- cbind(complete_data$folio, Predicted_Prob = predicted_probs[,2])

average_probs_by_folio <- aggregate(Predicted_Prob ~ V1, data = predicted_probs_with_folio, FUN = mean)

average_probs_by_folio <- average_probs_by_folio %>%
  rename(folio = V1)

df_model$pr_tc2_t1 <- average_probs_by_folio$Predicted_Prob

# Add folio variable to predicted_probs for comparison
predicted_probs_with_folio <- cbind(complete_data$folio, Predicted_Prob = predicted_probs[,3])

average_probs_by_folio <- aggregate(Predicted_Prob ~ V1, data = predicted_probs_with_folio, FUN = mean)

average_probs_by_folio <- average_probs_by_folio %>%
  rename(folio = V1)

df_model$pr_tc3_t1 <- average_probs_by_folio$Predicted_Prob

df_model$pr_trc_t1 <- NA
df_model$pr_trc_t1[df_model$treat_comp_t1_v1 == "Not Completed"] <- df_model$pr_tc1_t1 
df_model$pr_trc_t1[df_model$treat_comp_t1_v1 == "Completed" & is.na(df_model$pr_trc_t1)] <- df_model$pr_tc2_t1
df_model$pr_trc_t1[df_model$treat_comp_t1_v1 == "Currently in treatment" & is.na(df_model$pr_trc_t1)] <- df_model$pr_tc3_t1

summary(df_model$pr_tc1_t1)
summary(df_model$pr_tc2_t1)
summary(df_model$pr_tc3_t1)
summary(df_model$pr_trc_t1)

# Save MICE
# save(imp_c, file = "imp_c_v2.Rda")
```

### Plot
```{r eval=FALSE}
# Look at the weights
summary(df_model$iptw_tc_t1)
hist(df_model$iptw_tc_t1, main = "IPTW Density", xlab = "IPTW", breaks = 300)
density_plot <- density(df_model$iptw_tc_t1)
plot(density_plot, main = "IPTW Treatment compliance T1 Density", xlab = "IPTW", col = "blue")

# Check density across censored and uncensored T2
density_plot_t1_1 <- density(df_model$iptw_tc_t1[df_model$treat_comp_t1_v1 == "Not Completed"], na.rm = TRUE)
density_plot_t1_2 <- density(df_model$iptw_tc_t1[df_model$treat_comp_t1_v1 == "Completed"], na.rm = TRUE)
density_plot_t1_3 <- density(df_model$iptw_tc_t1[df_model$treat_comp_t1_v1 == "Currently in treatment"], na.rm = TRUE)

# Plot 
plot(density_plot_t1_1, main = "IPTW Treatment compliance T1 Density by treatment status", xlab = "IPTW Treatment compliance", col = "blue")
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
legend("topright", legend = c("Not Completed", "Completed", "Currently in treatment"), col = c("blue", "red", "green"), lty = 1)


# Probability TC == "Not Completed" / Not Completed treatment
density_plot <- density(df_model$pr_tc1_t1)
plot(density_plot, main = "Pr Not Completed treatment T1 Density", xlab = "Probability Not Completed treatment", col = "blue", xlim = c(0,1))

# Check density across censored and uncensored T2
density_plot_t1_1 <- density(df_model$pr_tc1_t1[df_model$treat_comp_t1_v1 == "Not Completed"], na.rm = TRUE)
density_plot_t1_2 <- density(df_model$pr_tc1_t1[df_model$treat_comp_t1_v1 == "Completed"], na.rm = TRUE)
density_plot_t1_3 <- density(df_model$pr_tc1_t1[df_model$treat_comp_t1_v1 == "Currently in treatment"], na.rm = TRUE)

# Plot 
plot(density_plot_t1_1, main = "Pr Not Completed treatment T1 Density by treatment status", xlab = "Probability Not Completed treatment", col = "blue", ylim = c(0, 4), xlim = c(0,1))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
legend("topright", legend = c("Not Completed", "Completed", "Currently in treatment"), col = c("blue", "red", "green"), lty = 1)

# Probability TC == "Completed" / completed
density_plot <- density(df_model$pr_tc2_t1)
plot(density_plot, main = "Pr completed T1 Density", xlab = "Probability completed", col = "blue", xlim = c(0,1))

# Check density across censored and uncensored T2
density_plot_t1_1 <- density(df_model$pr_tc2_t1[df_model$treat_comp_t1_v1 == "Not Completed"], na.rm = TRUE)
density_plot_t1_2 <- density(df_model$pr_tc2_t1[df_model$treat_comp_t1_v1 == "Completed"], na.rm = TRUE)
density_plot_t1_3 <- density(df_model$pr_tc2_t1[df_model$treat_comp_t1_v1 == "Currently in treatment"], na.rm = TRUE)

# Plot 
plot(density_plot_t1_1, main = "Pr completed T1 Density by treatment status", xlab = "Probability completed", col = "blue", ylim = c(0, 4), xlim = c(0,1))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
legend("topright", legend = c("Not Completed", "Completed", "Currently in treatment"), col = c("blue", "red", "green"), lty = 1)

# Probability TC == "Currently in treatment" / Currently in treatment
density_plot <- density(df_model$pr_tc3_t1)
plot(density_plot, main = "Pr  Currently in treatment T1 Density", xlab = "Probability  Currently in treatment", col = "blue", xlim = c(0,1))

# Check density across censored and uncensored T2
density_plot_t1_1 <- density(df_model$pr_tc3_t1[df_model$treat_comp_t1_v1 == "Not Completed"], na.rm = TRUE)
density_plot_t1_2 <- density(df_model$pr_tc3_t1[df_model$treat_comp_t1_v1 == "Completed"], na.rm = TRUE)
density_plot_t1_3 <- density(df_model$pr_tc3_t1[df_model$treat_comp_t1_v1 == "Currently in treatment"], na.rm = TRUE)

# Plot 
plot(density_plot_t1_1, main = "Pr  Currently in treatment T1 Density by treatment status", xlab = "Probability  Currently in treatment", col = "blue", ylim = c(0, 4), xlim = c(0,1))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
legend("topright", legend = c("Not Completed", "Completed", "Currently in treatment"), col = c("blue", "red", "green"), lty = 1)

# All probabilities
density_plot_t1_1 <- density(df_model$pr_tc1_t1, na.rm = TRUE)
density_plot_t1_2 <- density(df_model$pr_tc2_t1, na.rm = TRUE)
density_plot_t1_3 <- density(df_model$pr_tc3_t1, na.rm = TRUE)

plot(density_plot_t1_1, main = "Pr treatment status at T1 Density", xlab = "Probability treatment compliance at T1", col = "blue", ylim = c(0, 4), xlim = c(0,1))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
legend("topright", legend = c("Pr=Not Completed", "Pr=Completed", "Pr=Currently in treatment"), col = c("blue", "red", "green"), lty = 1)

# Pr actual treatment
density_plot_t1_1 <- density(df_model$pr_trc_t1[df_model$treat_comp_t1_v1 == "Not Completed"], na.rm = TRUE, bw = 0.01)
density_plot_t1_2 <- density(df_model$pr_trc_t1[df_model$treat_comp_t1_v1 == "Completed"], na.rm = TRUE, bw = 0.01)
density_plot_t1_3 <- density(df_model$pr_trc_t1[df_model$treat_comp_t1_v1 == "Currently in treatment"], na.rm = TRUE, bw = 0.01)

plot(density_plot_t1_1, main = "Pr actual treatment (compliance) at T1 Density", xlab = "Probability compliance treatment at T1", col = "blue", xlim = c(0,1), ylim = c(0,4.5))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
legend("topright", legend = c("Not Completed", "Completed", "Currently in treatment"), col = c("blue", "red", "green"), lty = 1)
```

### Extract iptw for outcome regression
```{r eval=FALSE}
df_iptw_t1 <- df_model[,c(1,34:38)]
save(df_iptw_t1, file = "df_iptw_tc_t1_v2.Rdata")
```

## Merge df_outcome with weights
```{r}
load(file = "df_ipcw_t2_v2.Rdata")
load(file = "df_iptw_tc_t1_v2.Rdata")

df_outcome <- df_tables
# IPCW
df_outcome <- merge(df_outcome,df_ipcw_t2,by="folio", all = T) 

# IPTW
df_outcome <- merge(df_outcome,df_iptw_t1,by="folio", all = T) 
```

### Standardized mean differences IPTW weights
```{r eval=FALSE}
## Create a variable list
vars <- c("treat_comp_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")

# IPCW
df_outcome <- df_outcome[!is.na(df_outcome$iptw_tc_t1), ]

tabNot <- CreateTableOne(vars = vars, strata = c("treat_comp_t1_v1"), smd = T, data = df_outcome)

# Create weighted data
df_outcome_Svy <- svydesign(ids = ~ 1, data = df_outcome, weights = ~ iptw_tc_t1)

## Create Table 1 stratified by trt
tabWeighted <- svyCreateTableOne(vars = vars, strata = c("treat_comp_t1_v1"), data = df_outcome_Svy, test = FALSE)

## Just typing the object name will invoke the print.TableOne method
print(tabNot, smd = TRUE, labels = mylabels)
print(tabWeighted, smd = TRUE, labels = mylabels)
```

## Final weights and trimmed data
```{r}
# Filter to those with weights
df_outcome <- df_outcome[complete.cases(df_outcome$iptw_tc_t1), ]

# Construct final weights
df_outcome$w_t <- df_outcome$ipcw_t2*df_outcome$iptw_tc_t1

# Trimm the weights 5-95
df_outcome$w_t_298 <- df_outcome$w_t
percentiles <- quantile(df_outcome$w_t_298, c(0.02, 0.98), na.rm = T)
percentiles
df_outcome$w_t_298[df_outcome$w_t <= percentiles[1]] <- NA

df_outcome$w_t_298[df_outcome$w_t >= percentiles[2]] <- NA

sd(df_outcome$w_t)
summary(df_outcome$w_t_298)
```

### Plots
```{r eval=FALSE}
# Plot
density_plot <- density(df_outcome$w_t)
plot(density_plot, main = "IPCW*IPTW time in Tx Density", xlab = "IPCW*IPTW", col = "blue")

# Check density across censored and uncensored T2
density_plot_t1_1 <- density(df_outcome$w_t[df_outcome$treat_comp_t1_v1 == "Not Completed"], na.rm = TRUE)
density_plot_t1_2 <- density(df_outcome$w_t[df_outcome$treat_comp_t1_v1 == "Completed"], na.rm = TRUE)
density_plot_t1_3 <- density(df_outcome$w_t[df_outcome$treat_comp_t1_v1 == "Currently in treatment"], na.rm = TRUE)

# Plot 
plot(density_plot_t1_1, main = "IPCW*IPTW treatment compliance in Tx by treatment status", xlab = "IPCW*IPTW", col = "blue", ylim = c(0, 1.4), xlim = c(0,max(df_outcome$w_t)))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
legend("topright", legend = c("Not Completed", "Completed", "Currently in treatment"), col = c("blue", "red", "green"), lty = 1)
```

#### Trimmed
```{r eval=FALSE}
# Plot
density_plot <- density(df_outcome$w_t_298, na.rm = T)
plot(density_plot, main = "IPCW*IPTW time in Tx Density", xlab = "IPCW*IPTW", col = "blue")

# Check density across censored and uncensored T2
density_plot_t1_1 <- density(df_outcome$w_t_298[df_outcome$treat_comp_t1_v1 == "Not Completed"], na.rm = TRUE)
density_plot_t1_2 <- density(df_outcome$w_t_298[df_outcome$treat_comp_t1_v1 == "Completed"], na.rm = TRUE)
density_plot_t1_3 <- density(df_outcome$w_t_298[df_outcome$treat_comp_t1_v1 == "Currently in treatment"], na.rm = TRUE)

# Plot 
plot(density_plot_t1_1, main = "IPCW*IPTW treatment compliance in Tx by treatment status trimmed", xlab = "IPCW*IPTW", col = "blue", ylim = c(0, 1.5), xlim = c(0,2.5))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
legend("topright", legend = c("Not Completed", "Completed", "Currently in treatment"), col = c("blue", "red", "green"), lty = 1)

# Pr actual treatment
density_plot_t1_1 <- density(df_outcome$pr_trc_t1[df_outcome$treat_comp_t1_v1 == "Not Completed" & !is.na(df_outcome$w_t_298)], na.rm = TRUE, bw = 0.01)
density_plot_t1_2 <- density(df_outcome$pr_trc_t1[df_outcome$treat_comp_t1_v1 == "Completed" & !is.na(df_outcome$w_t_298)], na.rm = TRUE, bw = 0.01)
density_plot_t1_3 <- density(df_outcome$pr_trc_t1[df_outcome$treat_comp_t1_v1 == "Currently in treatment" & !is.na(df_outcome$w_t_298)], na.rm = TRUE, bw = 0.01)

# Plot 
plot(density_plot_t1_1, main = "Pr actual treatment (compliance) at T1 Density trimmed", 
     xlab = "Probability compliance treatment at T1", col = "blue", xlim = c(0,1), ylim = c(0,5))
lines(density_plot_t1_2, col = "red")
lines(density_plot_t1_3, col = "green")
legend("topright", legend = c("Not Completed", "Completed", "Currently in treatment"), col = c("blue", "red", "green"), lty = 1)
```

### Table weights
```{r eval=FALSE}
weights <- tableby(treat_comp_t1_v1 ~ pr_notcen_t2 + ipcw_t2 + pr_tc1_t1 + pr_tc2_t1 + pr_tc3_t1  + pr_trc_t1+ iptw_tc_t1 + w_t + w_t_298, 
                  data = df_outcome, numeric.stats=c("mean", "sd", 
                                                    "medianq1q3", 
                                                    "min", "max", "Nmiss", "N"),
                  digits=2, digits.p=3, digits.pct=1, na.action(TRUE))

summary(weights, labelTranslations = mylabels, text=TRUE)

percentiles <- quantile(df_outcome$ipcw_t2, c(0, 0.02, 0.05, 0.1, 0.35, 0.5, 0.75, 0.9, 0.95, 0.98, 1), na.rm = T)
percentiles


percentiles <- quantile(df_outcome$iptw_tc_t1, c(0, 0.02, 0.05, 0.1, 0.35, 0.5, 0.75, 0.9, 0.95, 0.98, 1), na.rm = T)
percentiles

percentiles <- quantile(df_outcome$w_t, c(0, 0.02, 0.05, 0.1, 0.35, 0.5, 0.75, 0.9, 0.95, 0.98, 1), na.rm = T)
percentiles

summary(df_outcome$w_t)
```

## Standardized mean differences
```{r eval=FALSE}
## Create a variable list
vars <- c("treat_comp_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")

df_outcome <- df_outcome[!is.na(df_outcome$w_t), ]

# Create weighted data
df_outcome_Svy <- svydesign(ids = ~ 1, data = df_outcome, weights = ~ w_t)

## Create Table 1 stratified by trt
tabWeighted <- svyCreateTableOne(vars = vars, strata = c("treat_comp_t1_v1"), data = df_outcome_Svy, test = FALSE)

## Just typing the object name will invoke the print.TableOne method
print(tabWeighted, smd = TRUE, labels = mylabels)

df_outcome <- df_outcome[!is.na(df_outcome$w_t_298), ]

# Create weighted data
df_outcome_Svy <- svydesign(ids = ~ 1, data = df_outcome, weights = ~ w_t_298)

## Create Table 1 stratified by trt
tabWeighted <- svyCreateTableOne(vars = vars, strata = c("treat_comp_t1_v1"), data = df_outcome_Svy, test = FALSE)

## Just typing the object name will invoke the print.TableOne method
print(tabWeighted, smd = TRUE, labels = mylabels)
```

## Filter by common support area - Sensitivity 3
```{r eval=FALSE}
# maximum minimum Not completed 0.072
# minimum maximum Currently in treatment 0.761

df_outcome <- subset(df_outcome, pr_trc_t1 > 0.072 & pr_trc_t1 < 0.761) # 41 less cases
```

## Outcome model: Compliance with treatment

### Substance use: primary substance
```{r eval=FALSE}
# Creating dataset
df_sp <- df_outcome

complete_cases <- complete.cases(df_sp$sp_mprev_t2, df_sp$t2==1)
df_complete_cases <- df_sp[complete_cases, ]

df_complete_cases$sp_mprev_t2 <- as.numeric(df_complete_cases$sp_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("sp_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_sp1 <- glm(sp_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases)


t_m_sp1 <- tbl_regression(m_sp1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

# 7 Adjusted trimmed weights
m_sp7 <- geeglm(sp_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                id = folio,
                weights = w_t_298)

t_m_sp7 <-  tbl_regression(m_sp7, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

#### MICE
```{r eval=FALSE}
df_model <- df_sp

# MICE
df_model <- df_model[c("folio", "ipcw_t2",
                   "sp_mprev_t2",
                   "treat_comp_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")] # Disruptive events, For-profit crimes and ACEs 

complete_cases <- complete.cases(df_model$sp_mprev_t2)
df_model <- df_model[complete_cases, ]

p_missing <- unlist(lapply(df_model, function(x) sum(is.na(x))))/nrow(df_model)
round(sort(p_missing[p_missing > 0], decreasing = TRUE)*100,2)

# Run the mice code with 0 iterations 
imp <- mice(df_model, maxit=0)

# Extract predictorMatrix and methods of imputation 
predM <- imp$predictorMatrix
meth <- imp$method

# Setting values of variables I'd like to leave out to 0 in the predictor matrix
predM[, c("folio")] <- 0

# Specify a separate imputation model for variables of interest 

# Numerical variables
num <- c("readi", "ratio", "net_index_t0", "victnna_num")

# Dichotomous variable
log <- c("tto_primertrata_t0", "tbjo_t0", "pb_mprev_t0", 
         "drgs_ini", "p42", "tranq_mprev_t0" , "tto_30dias_t0" , "redes_vivedrogas_t0" , "mar_mprev_t0" , "sld_mini_antisoc_t0" )

# Ordered categorical variables 
poly <- c("educ_nivel2_t0")

# Unordered categorical variable 
poly2 <- c("prev_tto")

# Turn their methods matrix into the specified imputation models
meth[num] <- "norm.boot"
meth[log] <- "logreg.boot"
meth[poly] <- "polyreg"
meth[poly2] <- "polyreg"

# MICE
set.seed(12345)
imp2 <- mice(df_model, 
             m = 30,
             maxit = 10, 
             predictorMatrix = predM, 
             method = meth,
             print = FALSE)

set.seed(12345)
m_sp3 <- with(imp2,
            glm(sp_mprev_t2 ~ treat_comp_t1_v1 +
                             tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + 
                    pb_mprev_t0 + tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini + drgs_sp_t0 +  # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 + # Family and cohabitation
                    peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor +  + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0 + victnna_num,  
                 data = df_model, family = binomial))

mice_rr <- avg_comparisons(m_sp3, comparison = "ratio", variables = "treat_comp_t1_v1")

print(mice_rr, style = "data.frame")

t_m_sp3 <-  tbl_regression(m_sp3, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")            
```

#### Tables
```{r eval=FALSE}
t_m_sp1 
t_m_sp3 
t_m_sp7

nobs(m_sp7)
nobs(m_sp1)
```

```{r eval=FALSE}
# Create a list of your t_m_sp objects
t_m_sp_list <- list(t_m_sp1, t_m_sp3, t_m_sp7)

# Loop 
for (i in seq_along(t_m_sp_list)) {
  # Create the gtsummary table 
  table_for_current_dataset <- t_m_sp_list[[i]] %>%
    gtsummary::as_gt()

  # Save 
  gt::gtsave(table_for_current_dataset, file = sprintf("sp_model_%d.rtf", i))
}
```

### Substance use: alcohol
```{r eval=FALSE}
# Creating dataset
df_oh <- df_outcome

complete_cases <- complete.cases(df_oh$alco_mprev_t2, df_oh$t2==1)
df_complete_cases <- df_oh[complete_cases, ]

df_complete_cases$alco_mprev_t2 <- as.numeric(df_complete_cases$alco_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("alco_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_oh1 <- glm(alco_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases)


t_m_oh1 <- tbl_regression(m_oh1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

# 7 Adjusted trimmed weights
m_oh7 <- geeglm(alco_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                id = folio,
                weights = w_t_298)

t_m_oh7 <-  tbl_regression(m_oh7, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

#### MICE
```{r eval=FALSE}
df_model <- df_oh

# MICE
df_model <- df_model[c("folio", "ipcw_t2",
                   "alco_mprev_t2",
                   "treat_comp_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")] # Disruptive events, For-profit crimes and ACEs    

complete_cases <- complete.cases(df_model$alco_mprev_t2)
df_model <- df_model[complete_cases, ]

p_missing <- unlist(lapply(df_model, function(x) sum(is.na(x))))/nrow(df_model)
round(sort(p_missing[p_missing > 0], decreasing = TRUE)*100,2)

# Run the mice code with 0 iterations 
imp <- mice(df_model, maxit=0)

# Extract predictorMatrix and methods of imputation 
predM <- imp$predictorMatrix
meth <- imp$method

# Setting values of variables I'd like to leave out to 0 in the predictor matrix
predM[, c("folio")] <- 0

# Specify a separate imputation model for variables of interest 

# Numerical variables
num <- c("readi", "ratio", "net_index_t0", "victnna_num")

# Dichotomous variable
log <- c("tto_primertrata_t0", "tbjo_t0", "pb_mprev_t0", "p42", 
         "mar_mprev_t0", "coc_mprev_t0", "drgs_ini", "tranq_mprev_t0", 
         "tto_30dias_t0", "redes_vivedrogas_t0", "sld_mini_antisoc_t0")

# Ordered categorical variables tranq_mprev_t0
poly <- c("educ_nivel2_t0")

# Unordered categorical variable 
poly2 <- c("prev_tto")

# Turn their methods matrix into the specified imputation models
meth[num] <- "norm.boot"
meth[log] <- "logreg.boot"
meth[poly] <- "polyreg"
meth[poly2] <- "polyreg"

# MICE
set.seed(12345)
imp2 <- mice(df_model, 
             m = 30,
             maxit = 10, 
             predictorMatrix = predM, 
             method = meth,
             print = FALSE)

set.seed(12345)
m_oh3 <- with(imp2,
            glm(alco_mprev_t2 ~ treat_comp_t1_v1 +
                             tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + 
                    pb_mprev_t0 + tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini + drgs_sp_t0 +  # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 + # Family and cohabitation
                    peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor +  + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0 + victnna_num,  
                 data = df_model, family = binomial))

mice_rr <- avg_comparisons(m_oh3, comparison = "ratio", variables = "treat_comp_t1_v1")

print(mice_rr, style = "data.frame")

t_m_oh3 <-  tbl_regression(m_oh3, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")            

```

#### Tables
```{r eval=FALSE}
t_m_oh1 
t_m_oh3
t_m_oh7

nobs(m_oh1)
nobs(m_oh7)
```

```{r eval=FALSE}
# Create a list of your t_m_oh objects
t_m_oh_list <- list(t_m_oh1, t_m_oh3, t_m_oh7)

# Loop 
for (i in seq_along(t_m_oh_list)) {
  # Create the gtsummary table 
  table_for_current_dataset <- t_m_oh_list[[i]] %>%
    gtsummary::as_gt()

  # Save 
  gt::gtsave(table_for_current_dataset, file = sprintf("oh_model_%d.rtf", i))
}
```

### Substance use: cannabis
```{r eval=FALSE}
# Creating dataset
df_mar <- df_outcome

complete_cases <- complete.cases(df_mar$mar_mprev_t2, df_mar$t2==1)
df_complete_cases <- df_mar[complete_cases, ]

df_complete_cases$mar_mprev_t2 <- as.numeric(df_complete_cases$mar_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("mar_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_mar1 <- glm(mar_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases)

t_m_mar1 <- tbl_regression(m_mar1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

# 7 Adjusted trimmed weights
m_mar7 <- geeglm(mar_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                id = folio,
                weights = w_t_298)

t_m_mar7 <-  tbl_regression(m_mar7, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

#### MICE
```{r eval=FALSE}
df_model <- df_mar

# MICE
df_model <- df_model[c("folio", "ipcw_t2",
                   "mar_mprev_t2",
                   "treat_comp_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")] # Disruptive events, For-profit crimes and ACEs      

complete_cases <- complete.cases(df_model$mar_mprev_t2)
df_model <- df_model[complete_cases, ]

p_missing <- unlist(lapply(df_model, function(x) sum(is.na(x))))/nrow(df_model)
round(sort(p_missing[p_missing > 0], decreasing = TRUE)*100,2)

# Run the mice code with 0 iterations 
imp <- mice(df_model, maxit=0)

# Extract predictorMatrix and methods of imputation 
predM <- imp$predictorMatrix
meth <- imp$method

# Setting values of variables I'd like to leave out to 0 in the predictor matrix
predM[, c("folio")] <- 0

# Specify a separate imputation model for variables of interest 

# Numerical variables
num <- c("readi", "ratio", "net_index_t0", "victnna_num")

# Dichotomous variable
log <- c("tto_primertrata_t0", "tbjo_t0", "pb_mprev_t0", "p42",
         "coc_mprev_t0", "drgs_ini", "tranq_mprev_t0", "tto_30dias_t0", "redes_vivedrogas_t0", "sld_mini_antisoc_t0")

# Ordered categorical variables tranq_mprev_t0
#poly <- c("")

# Unordered categorical variable 
poly2 <- c("prev_tto")

# Turn their methods matrix into the specified imputation models
meth[num] <- "norm.boot"
meth[log] <- "logreg.boot"
meth[poly] <- "polyreg"
meth[poly2] <- "polyreg"

# MICE
set.seed(12345)
imp2 <- mice(df_model, 
             m = 30,
             maxit = 10, 
             predictorMatrix = predM, 
             method = meth,
             print = FALSE)

set.seed(12345)
m_mar3 <- with(imp2,
            glm(mar_mprev_t2 ~ treat_comp_t1_v1 +
                             tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + coc_mprev_t0 + 
                    pb_mprev_t0 + tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini + drgs_sp_t0 +  # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 + # Family and cohabitation
                    peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor +  + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0 + victnna_num,  
                 data = df_model, family = binomial))

mice_rr <- avg_comparisons(m_mar3, comparison = "ratio", variables = "treat_comp_t1_v1")

print(mice_rr, style = "data.frame")

t_m_mar3 <-  tbl_regression(m_mar3, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")            
```

#### Tables
```{r eval=FALSE}
t_m_mar1 
t_m_mar3 
t_m_mar7
```

```{r eval=FALSE}
# Create a list of your t_m_mar objects
t_m_mar_list <- list(t_m_mar1, t_m_mar3, t_m_mar7)

# Loop 
for (i in seq_along(t_m_mar_list)) {
  # Create the gtsummary table 
  table_for_current_dataset <- t_m_mar_list[[i]] %>%
    gtsummary::as_gt()

  # Save 
  gt::gtsave(table_for_current_dataset, file = sprintf("mar_model_%d.rtf", i))
}
```

### Substance use: cocaine
```{r eval=FALSE}
# Creating dataset
df_coc <- df_outcome

complete_cases <- complete.cases(df_coc$coc_mprev_t2, df_coc$t2==1)
df_complete_cases <- df_coc[complete_cases, ]

df_complete_cases$coc_mprev_t2 <- as.numeric(df_complete_cases$coc_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("coc_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_coc1 <- glm(coc_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases)

t_m_coc1 <- tbl_regression(m_coc1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

# 7 Adjusted trimmed weights
m_coc7 <- geeglm(coc_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                id = folio,
                weights = w_t_298)

t_m_coc7 <-  tbl_regression(m_coc7, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

#### MICE
```{r eval=FALSE}
df_model <- df_coc

# MICE
df_model <- df_model[c("folio", "ipcw_t2",
                   "coc_mprev_t2",
                   "treat_comp_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0","drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")] # Disruptive events, For-profit crimes and ACEs     

complete_cases <- complete.cases(df_model$coc_mprev_t2)
df_model <- df_model[complete_cases, ]

p_missing <- unlist(lapply(df_model, function(x) sum(is.na(x))))/nrow(df_model)
round(sort(p_missing[p_missing > 0], decreasing = TRUE)*100,2)

# Run the mice code with 0 iterations 
imp <- mice(df_model, maxit=0)

# Extract predictorMatrix and methods of imputation 
predM <- imp$predictorMatrix
meth <- imp$method

# Setting values of variables I'd like to leave out to 0 in the predictor matrix
predM[, c("folio")] <- 0

# Specify a separate imputation model for variables of interest 

# Numerical variables
num <- c("readi", "ratio", "net_index_t0", "victnna_num")

# Dichotomous variable
log <- c("tto_primertrata_t0", "tbjo_t0", "pb_mprev_t0", "p42", 
         "tranq_mprev_t0", "drgs_ini", "tto_30dias_t0", "sld_mini_antisoc_t0", "redes_vivedrogas_t0")

# Ordered categorical variables tranq_mprev_t0
#poly <- c("aces", "educ_nivel2_t0")
               
# Unordered categorical variable 
poly2 <- c("prev_tto")

# Turn their methods matrix into the specified imputation models
meth[num] <- "norm.boot"
meth[log] <- "logreg.boot"
meth[poly] <- "polyreg"
meth[poly2] <- "polyreg"

# MICE
set.seed(12345)
imp2 <- mice(df_model, 
             m = 30,
             maxit = 10, 
             predictorMatrix = predM, 
             method = meth,
             print = FALSE)

set.seed(12345)
m_coc3 <- with(imp2,
            glm(coc_mprev_t2 ~ treat_comp_t1_v1 +
                             tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + 
                    pb_mprev_t0 + tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini + drgs_sp_t0 +  # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 + # Family and cohabitation
                    peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor +  + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0 + victnna_num,  
                 data = df_model, family = binomial))

mice_rr <- avg_comparisons(m_coc3, comparison = "ratio", variables = "treat_comp_t1_v1")

print(mice_rr, style = "data.frame")

t_m_coc3 <-  tbl_regression(m_coc3, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")            
```

#### Tables
```{r eval=FALSE}
t_m_coc1 
t_m_coc3 
t_m_coc7
```

```{r eval=FALSE}
# Create a list of your t_m_coc objects
t_m_coc_list <- list(t_m_coc1,  t_m_coc3, t_m_coc7)

# Loop 
for (i in seq_along(t_m_coc_list)) {
  # Create the gtsumcocy table 
  table_for_current_dataset <- t_m_coc_list[[i]] %>%
    gtsummary::as_gt()

  # Save 
  gt::gtsave(table_for_current_dataset, file = sprintf("coc_model_%d.rtf", i))
}
```

### Substance use: cocaine paste
```{r eval=FALSE}
# Creating dataset
df_pb <- df_outcome

complete_cases <- complete.cases(df_pb$pb_mprev_t2, df_pb$t2==1)
df_complete_cases <- df_pb[complete_cases, ]

df_complete_cases$pb_mprev_t2 <- as.numeric(df_complete_cases$pb_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("pb_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_pb1 <- glm(pb_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases)

t_m_pb1 <- tbl_regression(m_pb1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

# 7 Adjusted trimmed weights
m_pb7 <- geeglm(pb_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                id = folio,
                weights = w_t_298)

t_m_pb7 <-  tbl_regression(m_pb7, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

#### MICE
```{r eval=FALSE}
df_model <- df_pb

# MICE
df_model <- df_model[c("folio", "ipcw_t2",
                   "pb_mprev_t2",
                   "treat_comp_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0",# Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")] # Disruptive events, For-profit crimes and ACEs       

complete_cases <- complete.cases(df_model$pb_mprev_t2)
df_model <- df_model[complete_cases, ]

p_missing <- unlist(lapply(df_model, function(x) sum(is.na(x))))/nrow(df_model)
round(sort(p_missing[p_missing > 0], decreasing = TRUE)*100,2)

# Run the mice code with 0 iterations 
imp <- mice(df_model, maxit=0)

# Extract predictorMatrix and methods of imputation 
predM <- imp$predictorMatrix
meth <- imp$method

# Setting values of variables I'd like to leave out to 0 in the predictor matrix
predM[, c("folio")] <- 0

# Specify a separate imputation model for variables of interest 

# Numerical variables
num <- c("readi", "ratio", "net_index_t0", "victnna_num")

# Dichotomous variable
log <- c("tto_primertrata_t0", "tbjo_t0", "redes_vivedrogas_t0", "tranq_mprev_t0", 
         "drgs_ini", "tto_30dias_t0", "coc_mprev_t0", "sld_mini_antisoc_t0", "p42")

# Ordered categorical variables tranq_mprev_t0
poly <- c("educ_nivel2_t0")

# Unordered categorical variable 
poly2 <- c("prev_tto")

# Turn their methods matrix into the specified imputation models
meth[num] <- "norm.boot"
meth[log] <- "logreg.boot"
meth[poly] <- "polyreg"
meth[poly2] <- "polyreg"

# MICE
set.seed(12345)
imp2 <- mice(df_model, 
             m = 30,
             maxit = 10, 
             predictorMatrix = predM, 
             method = meth,
             print = FALSE)

set.seed(12345)
m_pb3 <- with(imp2,
            glm(pb_mprev_t2 ~ treat_comp_t1_v1 +
                             tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + 
                    tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini +  # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 + # Family and cohabitation
                    peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor +  + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0 + victnna_num,  
                 data = df_model, family = binomial))

mice_rr <- avg_comparisons(m_pb3, comparison = "ratio", variables = "treat_comp_t1_v1")

print(mice_rr, style = "data.frame")

t_m_pb3 <-  tbl_regression(m_pb3, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")            
         
```

#### Tables
```{r eval=FALSE}
t_m_pb1 
t_m_pb3 
t_m_pb7
```

```{r eval=FALSE}
# Create a list of your t_m_pb objects
t_m_pb_list <- list(t_m_pb1, t_m_pb3, t_m_pb7)

# Loop 
for (i in seq_along(t_m_pb_list)) {
  # Create the gtsumpby table 
  table_for_current_dataset <- t_m_pb_list[[i]] %>%
    gtsummary::as_gt()

  # Save 
  gt::gtsave(table_for_current_dataset, file = sprintf("pb_model_%d.rtf", i))
}
```

### Psychiatric comorbidities
```{r eval=FALSE}
# Creating dataset
df_psyc <- df_outcome

complete_cases <- complete.cases(df_psyc$psyc_comor_t2, df_psyc$t2==1)
df_complete_cases <- df_psyc[complete_cases, ]

df_complete_cases$psyc_comor_t2 <- as.numeric(df_complete_cases$psyc_comor_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("psyc_comor_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_psyc1 <- glm(psyc_comor_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases)

t_m_psyc1 <- tbl_regression(m_psyc1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")


# 7 Adjusted trimmed weights
m_psyc7 <- geeglm(psyc_comor_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                id = folio,
                weights = w_t_298)

t_m_psyc7 <-  tbl_regression(m_psyc7, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

```

#### MICE
```{r eval=FALSE}
df_model <- df_psyc

# MICE
df_model <- df_model[c("folio", "ipcw_t2",
                   "psyc_comor_t2",
                   "treat_comp_t1_v1", #  Exposures
                        "tto_30dias_t0", "programa_t0", "ratio", "p42", # Center covariates
                        "sd_edad_t0", "sd_sexo_t0", "educ_nivel2_t0", "tbjo_t0", "ins_hous_t0", # Sociodemographics
                        "alco_mprev_t0", "mar_mprev_t0", "coc_mprev_t0", 
                        "pb_mprev_t0", "tranq_mprev_t0", "drgs_ini", "drgs_polimes_t0", "drgs_sp_t0", # Substance use
                        "readi", # Motivation to change
                        "prev_tto", "tto_primertrata_t0", # Prior treatment
                        "net_index_t0", "redes_vivedrogas_t0", # Family and cohabitation
                        "peers_sud_t0", "prtcp_9_t0", # Peers and Self-support groups
                        "phy_comor", "psyc_comor_t0", "sld_mini_antisoc_t0", # Comorbidities
                        "dis_event_t0", "fp_crime_t0", "victnna_num")] # Disruptive events, For-profit crimes and ACEs     

complete_cases <- complete.cases(df_model$psyc_comor_t2)
df_model <- df_model[complete_cases, ]

p_missing <- unlist(lapply(df_model, function(x) sum(is.na(x))))/nrow(df_model)
round(sort(p_missing[p_missing > 0], decreasing = TRUE)*100,2)

# Run the mice code with 0 iterations 
imp <- mice(df_model, maxit=0)

# Extract predictorMatrix and methods of imputation 
predM <- imp$predictorMatrix
meth <- imp$method

# Setting values of variables I'd like to leave out to 0 in the predictor matrix
predM[, c("folio")] <- 0

# Specify a separate imputation model for variables of interest 

# Numerical variables
num <- c("readi", "ratio", "net_index_t0", "victnna_num")

# Dichotomous variable
log <- c("tto_primertrata_t0", "tbjo_t0", "pb_mprev_t0", "tranq_mprev_t0", 
         "drgs_ini", "tto_30dias_t0", "redes_vivedrogas_t0", "mar_mprev_t0", "p42", "coc_mprev_t0", "sld_mini_antisoc_t0")

# Ordered categorical variables tranq_mprev_t0
poly <- c("educ_nivel2_t0")

# Unordered categorical variable 
poly2 <- c("prev_tto")

# Turn their methods matrix into the specified imputation models
meth[num] <- "norm.boot"
meth[log] <- "logreg.boot"
meth[poly] <- "polyreg"
meth[poly2] <- "polyreg"

# MICE
set.seed(12345)
imp2 <- mice(df_model, 
             m = 30,
             maxit = 10, 
             predictorMatrix = predM, 
             method = meth,
             print = FALSE)

set.seed(12345)
m_psyc3 <- with(imp2,
            glm(psyc_comor_t2 ~ treat_comp_t1_v1 +
                             tto_30dias_t0 + programa_t0 + ratio + p42 + # Center covariates
                    sd_edad_t0 + sd_sexo_t0 + educ_nivel2_t0 + tbjo_t0 + ins_hous_t0 + # Sociodemographics
                    alco_mprev_t0 + mar_mprev_t0 + coc_mprev_t0 + 
                    pb_mprev_t0 + tranq_mprev_t0 + drgs_polimes_t0 + drgs_ini + drgs_sp_t0 +  # Substance use
                    readi + # Motivation to change
                    prev_tto + tto_primertrata_t0 + # Prior treatment
                    net_index_t0 + redes_vivedrogas_t0 + # Family and cohabitation
                    peers_sud_t0 + prtcp_9_t0 + # Peers and Self-support groups
                    phy_comor +  + sld_mini_antisoc_t0 + # Comorbidities
                    dis_event_t0 + fp_crime_t0 + victnna_num,  
                 data = df_model, family = binomial))

mice_rr <- avg_comparisons(m_psyc3, comparison = "ratio", variables = "treat_comp_t1_v1")

print(mice_rr, style = "data.frame")

t_m_psyc3 <-  tbl_regression(m_psyc3, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")            
```

#### Tables
```{r eval=FALSE}
t_m_psyc1 
t_m_psyc3 
t_m_psyc7
```

```{r eval=FALSE}
# Create a list of your t_m_psyc objects
t_m_psyc_list <- list(t_m_psyc1, t_m_psyc3, t_m_psyc7)

# Loop 
for (i in seq_along(t_m_psyc_list)) {
  # Create the gtsumpsycy table 
  table_for_current_dataset <- t_m_psyc_list[[i]] %>%
    gtsummary::as_gt()

  # Save 
  gt::gtsave(table_for_current_dataset, file = sprintf("psyc_model_%d.rtf", i))
}
```

# Sensitivity analysis 5 - by treatment modelicy
## Outcome model: Time in treatment

### Substance use: primary substance
```{r eval=FALSE}
# Creating dataset
df_sp <- df_outcome

complete_cases <- complete.cases(df_sp$sp_mprev_t2, df_sp$t2==1)
df_complete_cases <- df_sp[complete_cases, ]

df_complete_cases$sp_mprev_t2 <- as.numeric(df_complete_cases$sp_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("sp_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_sp1 <- glm(sp_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Outpatient")

# 1 Unadjusted
m_sp2 <- glm(sp_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Inpatient")

t_m_sp1 <- tbl_regression(m_sp1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

t_m_sp2 <- tbl_regression(m_sp2, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

### Substance use: alcohol
```{r eval=FALSE}
# Creating dataset
df_oh <- df_outcome
complete_cases <- complete.cases(df_oh$alco_mprev_t2, df_oh$t2==1)
df_complete_cases <- df_oh[complete_cases, ]

df_complete_cases$alco_mprev_t2 <- as.numeric(df_complete_cases$alco_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("alco_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_oh1 <- glm(alco_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Outpatient")

# 1 Unadjusted
m_oh2 <- glm(alco_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Inpatient")


t_m_oh1 <- tbl_regression(m_oh1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

t_m_oh2 <- tbl_regression(m_oh2, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

### Substance use: cannabis
```{r eval=FALSE}
# Creating dataset
df_mar <- df_outcome

complete_cases <- complete.cases(df_mar$mar_mprev_t2, df_mar$t2==1)
df_complete_cases <- df_mar[complete_cases, ]

df_complete_cases$mar_mprev_t2 <- as.numeric(df_complete_cases$mar_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("mar_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_mar1 <- glm(mar_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Outpatient")

m_mar2 <- glm(mar_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Inpatient")


t_m_mar1 <- tbl_regression(m_mar1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

t_m_mar2 <- tbl_regression(m_mar2, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

### Substance use: cocaine
```{r eval=FALSE}
# Creating dataset
df_coc <- df_outcome

complete_cases <- complete.cases(df_coc$coc_mprev_t2, df_coc$t2==1)
df_complete_cases <- df_coc[complete_cases, ]

df_complete_cases$coc_mprev_t2 <- as.numeric(df_complete_cases$coc_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("coc_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_coc1 <- glm(coc_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Outpatient")

m_coc2 <- glm(coc_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Inpatient")

t_m_coc1 <- tbl_regression(m_coc1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

t_m_coc2 <- tbl_regression(m_coc2, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

### Substance use: cocaine paste
```{r eval=FALSE}
# Creating dataset
df_pb <- df_outcome

complete_cases <- complete.cases(df_pb$pb_mprev_t2, df_pb$t2==1)
df_complete_cases <- df_pb[complete_cases, ]

df_complete_cases$pb_mprev_t2 <- as.numeric(df_complete_cases$pb_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("pb_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_pb1 <- glm(pb_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Outpatient")

m_pb2 <- glm(pb_mprev_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Inpatient")

t_m_pb1 <- tbl_regression(m_pb1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

t_m_pb2 <- tbl_regression(m_pb2, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

### Psychiatric comorbidities
```{r eval=FALSE}
# Creating dataset
df_psyc <- df_outcome

complete_cases <- complete.cases(df_psyc$psyc_comor_t2, df_psyc$t2==1)
df_complete_cases <- df_psyc[complete_cases, ]

df_complete_cases$psyc_comor_t2 <- as.numeric(df_complete_cases$psyc_comor_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("psyc_comor_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_psyc1 <- glm(psyc_comor_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Outpatient")

m_psyc2 <- glm(psyc_comor_t2 ~ treat_time_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Inpatient")

t_m_psyc1 <- tbl_regression(m_psyc1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

t_m_psyc2 <- tbl_regression(m_psyc2, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```


## Outcome model: Compliance with treatment

### Substance use: primary substance
```{r eval=FALSE}
# Creating dataset
df_sp <- df_outcome

complete_cases <- complete.cases(df_sp$sp_mprev_t2, df_sp$t2==1)
df_complete_cases <- df_sp[complete_cases, ]

df_complete_cases$sp_mprev_t2 <- as.numeric(df_complete_cases$sp_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("sp_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_sp1 <- glm(sp_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Outpatient")

m_sp2 <- glm(sp_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Inpatient")

t_m_sp1 <- tbl_regression(m_sp1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

t_m_sp2 <- tbl_regression(m_sp2, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

### Substance use: alcohol
```{r eval=FALSE}
# Creating dataset
df_oh <- df_outcome

complete_cases <- complete.cases(df_oh$alco_mprev_t2, df_oh$t2==1)
df_complete_cases <- df_oh[complete_cases, ]

df_complete_cases$alco_mprev_t2 <- as.numeric(df_complete_cases$alco_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("alco_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_oh1 <- glm(alco_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Outpatient")

m_oh2 <- glm(alco_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Inpatient")


t_m_oh1 <- tbl_regression(m_oh1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

t_m_oh2 <- tbl_regression(m_oh2, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

### Substance use: cannabis
```{r eval=FALSE}
# Creating dataset
df_mar <- df_outcome

complete_cases <- complete.cases(df_mar$mar_mprev_t2, df_mar$t2==1)
df_complete_cases <- df_mar[complete_cases, ]

df_complete_cases$mar_mprev_t2 <- as.numeric(df_complete_cases$mar_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("mar_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_mar1 <- glm(mar_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Outpatient")

m_mar2 <- glm(mar_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Inpatient")

t_m_mar1 <- tbl_regression(m_mar1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

t_m_mar2 <- tbl_regression(m_mar2, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

### Substance use: cocaine
```{r eval=FALSE}
# Creating dataset
df_coc <- df_outcome

complete_cases <- complete.cases(df_coc$coc_mprev_t2, df_coc$t2==1)
df_complete_cases <- df_coc[complete_cases, ]

df_complete_cases$coc_mprev_t2 <- as.numeric(df_complete_cases$coc_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("coc_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_coc1 <- glm(coc_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Outpatient")

m_coc2 <- glm(coc_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Inpatient")

t_m_coc1 <- tbl_regression(m_coc1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

t_m_coc2 <- tbl_regression(m_coc2, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

### Substance use: cocaine paste
```{r eval=FALSE}
# Creating dataset
df_pb <- df_outcome

complete_cases <- complete.cases(df_pb$pb_mprev_t2, df_pb$t2==1)
df_complete_cases <- df_pb[complete_cases, ]

df_complete_cases$pb_mprev_t2 <- as.numeric(df_complete_cases$pb_mprev_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("pb_mprev_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_pb1 <- glm(pb_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Outpatient")

m_pb2 <- glm(pb_mprev_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Inpatient")

t_m_pb1 <- tbl_regression(m_pb1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

t_m_pb2 <- tbl_regression(m_pb2, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```

### Psychiatric comorbidities
```{r eval=FALSE}
# Creating dataset
df_psyc <- df_outcome

complete_cases <- complete.cases(df_psyc$psyc_comor_t2, df_psyc$t2==1)
df_complete_cases <- df_psyc[complete_cases, ]

df_complete_cases$psyc_comor_t2 <- as.numeric(df_complete_cases$psyc_comor_t2)

df_complete_cases <- df_complete_cases %>%
  mutate_at(vars("psyc_comor_t2"), 
            function(x) car::recode(x, "1=0;2=1"))

# 1 Unadjusted
m_psyc1 <- glm(psyc_comor_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Outpatient")

m_psyc2 <- glm(psyc_comor_t2 ~ treat_comp_t1_v1,
                family = binomial(link = "log"),
                data = df_complete_cases,
                subset = df_complete_cases$programa_t0 == "Inpatient")

t_m_psyc1 <- tbl_regression(m_psyc1, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")

t_m_psyc2 <- tbl_regression(m_psyc2, exponentiate = TRUE, label = mylabels) %>%
  add_n(location = "label")
```
